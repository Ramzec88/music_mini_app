<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéÅ –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –¥–ª—è —Ç–µ–±—è!</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.9.6/lottie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg, #fdd39e 0%, #fbb47a 50%, #f46b8a 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow-x: hidden;
      position: relative;
      text-align: center;
      transition: background 0.8s ease;
    }

    /* Theme Variants */
    body.cosmic-theme {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    }

    body.cosmic-theme .particle {
      background: rgba(255, 255, 255, 0.6);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
    }

    /* Theme Switcher Styles */
    .theme-switcher {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 100;
      min-width: 300px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      transition: all 0.4s ease;
      transform: translateX(0);
    }

    .theme-switcher.hidden {
      transform: translateX(calc(100% + 40px));
      opacity: 0;
      pointer-events: none;
    }

    .theme-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      margin-bottom: 20px;
    }

    .theme-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #666;
      transition: all 0.3s ease;
    }

    .theme-option.active {
      color: #333;
      transform: scale(1.1);
    }

    .theme-preview {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid transparent;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .theme-preview:hover {
      transform: scale(1.1);
      border-color: rgba(0, 0, 0, 0.2);
    }

    .theme-preview.active {
      border-color: #333;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .peach-preview {
      background: linear-gradient(135deg, #fdd39e, #f46b8a);
    }

    .cosmic-preview {
      background: linear-gradient(135deg, #667eea, #f093fb);
    }

    .theme-slider {
      position: relative;
    }

    .theme-checkbox {
      display: none;
    }

    .theme-slider-label {
      display: block;
      width: 60px;
      height: 30px;
      background: linear-gradient(135deg, #fdd39e, #f46b8a);
      border-radius: 15px;
      cursor: pointer;
      position: relative;
      transition: all 0.4s ease;
      box-shadow: 0 4px 15px rgba(244, 107, 138, 0.3);
    }

    .theme-checkbox:checked + .theme-slider-label {
      background: linear-gradient(135deg, #667eea, #f093fb);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .theme-slider-button {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .theme-checkbox:checked + .theme-slider-label .theme-slider-button {
      transform: translateX(30px);
    }

    .apply-theme-btn {
      width: 100%;
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: white;
      border: none;
      border-radius: 15px;
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
    }

    .apply-theme-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
    }

    /* Floating particles background */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      animation: float-particle 8s infinite ease-in-out;
    }

    @keyframes float-particle {
      0%, 100% { 
        transform: translateY(0px) translateX(0px) rotate(0deg); 
        opacity: 0.2; 
      }
      25% { 
        transform: translateY(-30px) translateX(20px) rotate(90deg); 
        opacity: 0.6; 
      }
      50% { 
        transform: translateY(-60px) translateX(-10px) rotate(180deg); 
        opacity: 0.8; 
      }
      75% { 
        transform: translateY(-30px) translateX(-20px) rotate(270deg); 
        opacity: 0.6; 
      }
    }

    .main-content {
      position: relative;
      z-index: 1;
      animation: fadeInUp 1.2s ease-out;
    }

    h1 {
      font-size: clamp(28px, 7vw, 42px);
      font-weight: 700;
      margin-bottom: 15px;
      color: #fff;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      animation: fadeInUp 1s ease-out;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.95);
      font-size: clamp(16px, 4vw, 20px);
      margin-bottom: 40px;
      font-weight: 500;
      animation: fadeInUp 1s ease-out 0.3s both;
    }

    #envelope-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
      animation: fadeInUp 1s ease-out 0.6s both;
    }

    #envelope {
      width: clamp(250px, 55vw, 380px);
      height: clamp(250px, 55vw, 380px);
      filter: drop-shadow(0 15px 35px rgba(0, 0, 0, 0.2));
      animation: float 4s ease-in-out infinite;
      transition: transform 0.4s ease;
      cursor: pointer;
    }

    #envelope:hover {
      transform: scale(1.05) translateY(-5px);
      filter: drop-shadow(0 20px 45px rgba(0, 0, 0, 0.25));
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .open-btn {
      background: linear-gradient(135deg, #f46b8a, #e64d6e);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 18px 36px;
      font-size: clamp(16px, 4vw, 20px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 8px 25px rgba(244, 107, 138, 0.4);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    body.cosmic-theme .open-btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    body.cosmic-theme .open-btn:hover {
      background: linear-gradient(135deg, #764ba2, #667eea);
      box-shadow: 0 15px 35px rgba(118, 75, 162, 0.5);
    }

    .open-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .open-btn:hover::before {
      left: 100%;
    }

    .open-btn:hover {
      background: linear-gradient(135deg, #e64d6e, #d63d5d);
      box-shadow: 0 15px 35px rgba(230, 77, 110, 0.5);
      transform: translateY(-3px) scale(1.05);
    }

    .open-btn:active {
      transform: translateY(-1px) scale(1.02);
    }

    #song-card {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      width: clamp(340px, 90vw, 480px);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(30px);
      border-radius: 30px;
      padding: 45px 35px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.4);
      opacity: 0;
      transition: all 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      text-align: center;
    }

    #song-card.show {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    #song-card h2 {
      font-size: clamp(24px, 6vw, 32px);
      margin-bottom: 15px;
      background: linear-gradient(135deg, #f46b8a, #e64d6e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }

    #song-card p {
      color: #666;
      font-size: clamp(14px, 3.5vw, 16px);
      margin-bottom: 25px;
      line-height: 1.6;
      font-weight: 500;
    }

    .song-info {
      background: linear-gradient(135deg, #fdd39e20, #fbb47a20);
      border-radius: 20px;
      padding: 25px;
      margin: 25px 0;
      border-left: 5px solid #f46b8a;
      backdrop-filter: blur(10px);
    }

    .song-title {
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
      font-size: clamp(16px, 4vw, 18px);
    }

    .song-artist {
      color: #666;
      font-size: clamp(12px, 3vw, 14px);
      font-weight: 500;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
      align-items: center;
      margin-top: 25px;
    }

    .play-btn {
      background: linear-gradient(135deg, #f46b8a, #e64d6e);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 16px 32px;
      font-size: clamp(14px, 4vw, 16px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s ease;
      box-shadow: 0 8px 25px rgba(244, 107, 138, 0.4);
      width: 100%;
      max-width: 280px;
      position: relative;
      overflow: hidden;
    }

    .play-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .play-btn:hover::before {
      left: 100%;
    }

    .play-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(244, 107, 138, 0.5);
    }

    .download-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-decoration: none;
      background: linear-gradient(135deg, #fbb47a, #f46b8a);
      color: white;
      padding: 14px 28px;
      border-radius: 50px;
      font-size: clamp(12px, 3.5vw, 14px);
      font-weight: 700;
      transition: all 0.4s ease;
      box-shadow: 0 6px 20px rgba(251, 180, 122, 0.4);
      width: 100%;
      max-width: 280px;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(251, 180, 122, 0.5);
      background: linear-gradient(135deg, #f46b8a, #e64d6e);
    }

    .share-section {
      margin-top: 30px;
      padding-top: 25px;
      border-top: 1px solid rgba(244, 107, 138, 0.2);
    }

    .share-text {
      color: #666;
      font-size: clamp(12px, 3vw, 14px);
      margin-bottom: 15px;
      font-weight: 500;
    }

    .share-btn {
      background: linear-gradient(135deg, #fdd39e, #fbb47a);
      color: #333;
      border: none;
      border-radius: 50px;
      padding: 14px 28px;
      font-size: clamp(12px, 3.5vw, 14px);
      font-weight: 700;
      cursor: pointer;
      transition: all 0.4s ease;
      box-shadow: 0 6px 20px rgba(253, 211, 158, 0.4);
      width: 100%;
      max-width: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 0 auto;
    }

    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(253, 211, 158, 0.5);
      background: linear-gradient(135deg, #fbb47a, #f46b8a);
      color: white;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 25px;
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .close-btn:hover {
      color: #333;
      background: rgba(244, 107, 138, 0.1);
      transform: rotate(90deg);
    }

    .hidden {
      display: none !important;
    }

    .audio-visualizer {
      width: 100%;
      height: 70px;
      background: linear-gradient(135deg, #f46b8a, #e64d6e);
      border-radius: 15px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    .wave-animation {
      position: absolute;
      width: 200%;
      height: 100%;
      background: repeating-linear-gradient(
        90deg,
        rgba(255, 255, 255, 0.1) 0px,
        rgba(255, 255, 255, 0.3) 15px,
        rgba(255, 255, 255, 0.1) 30px
      );
      animation: wave 3s linear infinite;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .wave-animation.playing {
      opacity: 1;
    }

    @keyframes wave {
      0% { transform: translateX(-50%); }
      100% { transform: translateX(0%); }
    }

    .visualizer-text {
      color: white;
      font-weight: 700;
      z-index: 1;
      font-size: clamp(12px, 3vw, 14px);
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced responsive design */
    @media (max-width: 768px) {
      .main-content {
        padding: 0 20px;
      }

      #song-card {
        margin: 20px;
        width: calc(100vw - 40px);
        max-width: 420px;
        padding: 35px 25px;
      }

      .controls {
        gap: 12px;
      }

      .theme-switcher {
        top: 10px;
        right: 10px;
        min-width: 280px;
        padding: 15px;
      }

      .theme-toggle {
        gap: 10px;
      }

      .theme-preview {
        width: 35px;
        height: 35px;
      }
    }

    @media (max-width: 480px) {
      #envelope {
        width: clamp(200px, 70vw, 300px);
        height: clamp(200px, 70vw, 300px);
      }

      .open-btn {
        padding: 16px 28px;
        font-size: 16px;
      }

      #song-card {
        padding: 30px 20px;
      }
    }

    /* Loading state */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="particles" id="particles"></div>
  
  <!-- Theme Switcher -->
  <div class="theme-switcher" id="theme-switcher">
    <div class="theme-label">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</div>
    <div class="theme-toggle">
      <div class="theme-option" data-theme="peach">
        <div class="theme-preview peach-preview"></div>
        <span>–¢–µ–ø–ª–∞—è</span>
      </div>
      <div class="theme-slider">
        <input type="checkbox" id="theme-toggle" class="theme-checkbox">
        <label for="theme-toggle" class="theme-slider-label">
          <span class="theme-slider-button"></span>
        </label>
      </div>
      <div class="theme-option" data-theme="cosmic">
        <div class="theme-preview cosmic-preview"></div>
        <span>–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è</span>
      </div>
    </div>
    <button class="apply-theme-btn" id="apply-theme">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ —Å–∫—Ä—ã—Ç—å</button>
  </div>

  <div class="main-content">
    <h1>üéÅ –î–ª—è —Ç–µ–±—è –æ—Å–æ–±–µ–Ω–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫!</h1>
    <p class="subtitle">–û—Ç–∫—Ä–æ–π –∏ –ø–æ—Å–ª—É—à–∞–π —Å–≤–æ—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –ø–µ—Å–Ω—é ‚ú®</p>

    <div id="envelope-container">
      <div id="envelope"></div>
      <button id="open-btn" class="open-btn">üéµ –û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫</button>
    </div>
  </div>

  <div id="song-card" class="hidden">
    <button class="close-btn" id="close-btn">√ó</button>
    <h2>üéâ –° –î–Ω—ë–º –†–æ–∂–¥–µ–Ω–∏—è, –ê–ª–µ–∫—Å–µ–π!</h2>
    <p>–≠—Ç–∞ –ø–µ—Å–Ω—è —Å–æ–∑–¥–∞–Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–±—è! –ù–∞—Å–ª–∞–¥–∏—Å—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∫–æ–º–ø–æ–∑–∏—Ü–∏–µ–π üé∂</p>
    
    <div class="song-info">
      <div class="song-title">üéµ "Happy Birthday Alexey"</div>
      <div class="song-artist">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è ‚Ä¢ –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ –¥–ª—è —Ç–µ–±—è</div>
    </div>

    <div class="audio-visualizer">
      <div class="wave-animation" id="wave-animation"></div>
      <span class="visualizer-text">üéµ –¢–≤–æ—è –ø–µ—Å–Ω—è –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—é</span>
    </div>

    <div class="controls">
      <button id="play-btn" class="play-btn">‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å –º–æ—é –ø–µ—Å–Ω—é</button>
      <a href="#" class="download-btn" id="download-link">
        <span>üíæ</span>
        <span>–°–∫–∞—á–∞—Ç—å –ø–µ—Å–Ω—é</span>
      </a>
    </div>

    <div class="share-section">
      <p class="share-text">–ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è –ø–æ–¥–∞—Ä–æ–∫? –ü–æ–¥–µ–ª–∏—Å—å —Å –¥—Ä—É–∑—å—è–º–∏! üéÅ</p>
      <button class="share-btn" id="share-btn">
        <span>üì§</span>
        <span>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–¥–∞—Ä–∫–æ–º</span>
      </button>
    </div>

    <audio id="audio" preload="auto">
      <source src="assets/song.mp3" type="audio/mpeg">
      –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
    </audio>
  </div>

  <script>
    // Theme switching functionality
    const themeToggle = document.getElementById('theme-toggle');
    const themeSwitcher = document.getElementById('theme-switcher');
    const applyThemeBtn = document.getElementById('apply-theme');
    const peachOption = document.querySelector('[data-theme="peach"]');
    const cosmicOption = document.querySelector('[data-theme="cosmic"]');
    const peachPreview = document.querySelector('.peach-preview');
    const cosmicPreview = document.querySelector('.cosmic-preview');

    // Initialize theme state
    let currentTheme = 'peach';

    function updateThemeUI() {
      if (currentTheme === 'peach') {
        peachOption.classList.add('active');
        cosmicOption.classList.remove('active');
        peachPreview.classList.add('active');
        cosmicPreview.classList.remove('active');
        themeToggle.checked = false;
      } else {
        cosmicOption.classList.add('active');
        peachOption.classList.remove('active');
        cosmicPreview.classList.add('active');
        peachPreview.classList.remove('active');
        themeToggle.checked = true;
      }
    }

    function applyTheme(theme) {
      if (theme === 'cosmic') {
        document.body.classList.add('cosmic-theme');
      } else {
        document.body.classList.remove('cosmic-theme');
      }
      currentTheme = theme;
      updateThemeUI();
      
      // Update confetti colors
      updateConfettiColors();
    }

    function updateConfettiColors() {
      if (currentTheme === 'cosmic') {
        window.confettiColors = ['#667eea', '#764ba2', '#f093fb', '#ffffff', '#e0c3fc'];
      } else {
        window.confettiColors = ['#fdd39e', '#fbb47a', '#f46b8a', '#e64d6e', '#ffffff'];
      }
    }

    // Theme toggle event listener
    themeToggle.addEventListener('change', () => {
      applyTheme(themeToggle.checked ? 'cosmic' : 'peach');
    });

    // Theme preview click handlers
    peachPreview.addEventListener('click', () => {
      applyTheme('peach');
    });

    cosmicPreview.addEventListener('click', () => {
      applyTheme('cosmic');
    });

    // Apply and hide theme switcher
    applyThemeBtn.addEventListener('click', () => {
      themeSwitcher.classList.add('hidden');
      
      // Store theme preference
      localStorage.setItem('gift-theme', currentTheme);
      
      // Success feedback
      const originalText = applyThemeBtn.textContent;
      applyThemeBtn.textContent = '‚ú® –¢–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!';
      setTimeout(() => {
        applyThemeBtn.textContent = originalText;
      }, 2000);
    });

    // Show theme switcher on double click (for testing)
    document.addEventListener('dblclick', (e) => {
      if (e.ctrlKey || e.metaKey) {
        themeSwitcher.classList.remove('hidden');
      }
    });

    // Initialize theme from URL parameter or localStorage
    function initializeTheme() {
      const urlParams = new URLSearchParams(window.location.search);
      const urlTheme = urlParams.get('theme');
      const savedTheme = localStorage.getItem('gift-theme');
      
      // Priority: URL > localStorage > default
      const initialTheme = urlTheme || savedTheme || 'peach';
      applyTheme(initialTheme);
      
      // Auto-hide theme switcher after 10 seconds if no interaction
      setTimeout(() => {
        if (!themeSwitcher.classList.contains('hidden')) {
          themeSwitcher.style.opacity = '0.7';
        }
      }, 10000);
    }

    // Create enhanced floating particles
    function createParticles() {
      const particles = document.getElementById('particles');
      for (let i = 0; i < 60; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 8 + 's';
        particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
        particles.appendChild(particle);
      }
    }

    // Initialize Lottie animation with fallback
    let envelope;
    try {
      envelope = lottie.loadAnimation({
        container: document.getElementById('envelope'),
        renderer: 'svg',
        loop: false,
        autoplay: false,
        path: 'assets/envelope_open.json'
      });
    } catch (error) {
      console.log('Lottie failed to load, using fallback');
      document.getElementById('envelope').innerHTML = `
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 120px; background: linear-gradient(135deg, #fdd39e, #fbb47a); border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); transition: all 0.3s ease;">
          üíå
        </div>
      `;
    }

    // State variables
    let isOpen = false;
    let isPlaying = false;
    const songCard = document.getElementById('song-card');
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('play-btn');
    const waveAnimation = document.getElementById('wave-animation');
    const openBtn = document.getElementById('open-btn');
    const closeBtn = document.getElementById('close-btn');

    // Enhanced confetti celebration
    function celebrationEffect() {
      const duration = 4000;
      const animationEnd = Date.now() + duration;
      const colors = window.confettiColors || ['#fdd39e', '#fbb47a', '#f46b8a', '#e64d6e', '#ffffff'];
      const defaults = { 
        startVelocity: 35, 
        spread: 360, 
        ticks: 80, 
        zIndex: 0,
        colors: colors
      };

      function randomInRange(min, max) {
        return Math.random() * (max - min) + min;
      }

      const interval = setInterval(function() {
        const timeLeft = animationEnd - Date.now();

        if (timeLeft <= 0) {
          return clearInterval(interval);
        }

        const particleCount = 60 * (timeLeft / duration);

        // Multiple confetti bursts
        confetti(Object.assign({}, defaults, {
          particleCount,
          origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
        }));
        confetti(Object.assign({}, defaults, {
          particleCount,
          origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
        }));
        
        // Center burst
        if (timeLeft > duration * 0.8) {
          confetti(Object.assign({}, defaults, {
            particleCount: particleCount * 1.5,
            origin: { x: 0.5, y: 0.5 }
          }));
        }
      }, 250);
    }

    // Open envelope with enhanced animation
    openBtn.addEventListener('click', () => {
      if (!isOpen) {
        openBtn.classList.add('loading');
        openBtn.textContent = '‚ú® –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...';
        openBtn.disabled = true;

        if (envelope && envelope.totalFrames) {
          envelope.play();
          envelope.addEventListener('complete', showSongCard, { once: true });
        } else {
          // Fallback animation
          const envelopeEl = document.getElementById('envelope');
          envelopeEl.style.transform = 'rotateY(180deg) scale(1.1)';
          setTimeout(showSongCard, 800);
        }
      }
    });

    function showSongCard() {
      isOpen = true;
      songCard.classList.remove('hidden');
      setTimeout(() => songCard.classList.add('show'), 100);
      celebrationEffect();
      
      // Reset button with delay
      setTimeout(() => {
        openBtn.classList.remove('loading');
        openBtn.textContent = 'üîí –ó–∞–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫';
        openBtn.disabled = false;
      }, 1500);
    }

    // Close song card with cleanup
    closeBtn.addEventListener('click', closeSongCard);

    function closeSongCard() {
      songCard.classList.remove('show');
      setTimeout(() => {
        songCard.classList.add('hidden');
        isOpen = false;
        openBtn.textContent = 'üéµ –û—Ç–∫—Ä—ã—Ç—å –ø–æ–¥–∞—Ä–æ–∫';
        
        if (envelope && envelope.totalFrames) {
          envelope.goToAndStop(0, true);
        } else {
          document.getElementById('envelope').style.transform = 'rotateY(0deg) scale(1)';
        }
        
        // Stop audio if playing
        if (isPlaying) {
          audio.pause();
          audio.currentTime = 0;
          isPlaying = false;
          playBtn.textContent = '‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å –º–æ—é –ø–µ—Å–Ω—é';
          waveAnimation.classList.remove('playing');
        }
      }, 500);
    }

    // Enhanced play/pause functionality
    playBtn.addEventListener('click', () => {
      if (audio.paused) {
        audio.play().then(() => {
          isPlaying = true;
          playBtn.textContent = '‚è∏Ô∏è –ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–∞—É–∑—É';
          waveAnimation.classList.add('playing');
        }).catch(error => {
          console.log('Audio play failed:', error);
          playBtn.textContent = '‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è';
          setTimeout(() => {
            playBtn.textContent = '‚ñ∂Ô∏è –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
          }, 2000);
        });
      } else {
        audio.pause();
        isPlaying = false;
        playBtn.textContent = '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–ª—É—à–∞—Ç—å';
        waveAnimation.classList.remove('playing');
      }
    });

    // Audio event handlers
    audio.addEventListener('ended', () => {
      isPlaying = false;
      playBtn.textContent = 'üîÅ –°–ª—É—à–∞—Ç—å –µ—â—ë —Ä–∞–∑';
      waveAnimation.classList.remove('playing');
    });

    audio.addEventListener('loadstart', () => {
      console.log('Audio loading started');
    });

    audio.addEventListener('canplaythrough', () => {
      console.log('Audio can play through');
    });

    // Enhanced share functionality
    document.getElementById('share-btn').addEventListener('click', async () => {
      const shareData = {
        title: 'üéÅ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫!',
        text: '–ü–æ—Å–º–æ—Ç—Ä–∏, –∫–∞–∫–æ–π –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ —è –ø–æ–ª—É—á–∏–ª! –≠—Ç–æ –º–æ—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–µ—Å–Ω—è! üéµ‚ú®',
        url: window.location.href
      };

      if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
        try {
          await navigator.share(shareData);
          // Success feedback
          const btn = document.getElementById('share-btn');
          const originalText = btn.innerHTML;
          btn.innerHTML = '<span>‚úÖ</span><span>–ü–æ–¥–µ–ª–∏–ª—Å—è!</span>';
          setTimeout(() => {
            btn.innerHTML = originalText;
          }, 2000);
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.log('Share failed:', err);
            fallbackShare();
          }
        }
      } else {
        fallbackShare();
      }
    });

    function fallbackShare() {
      const url = encodeURIComponent(window.location.href);
      const text = encodeURIComponent('–ü–æ—Å–º–æ—Ç—Ä–∏, –∫–∞–∫–æ–π –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ —è –ø–æ–ª—É—á–∏–ª! –≠—Ç–æ –º–æ—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–µ—Å–Ω—è! üéµ‚ú®');
      
      const shareOptions = [
        { name: 'üì± WhatsApp', url: `https://wa.me/?text=${text}%20${url}` },
        { name: '‚úàÔ∏è Telegram', url: `https://telegram.me/share/url?url=${url}&text=${text}` },
        { name: 'üîµ VKontakte', url: `https://vk.com/share.php?url=${url}&title=${text}` },
        { name: 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', action: 'copy' }
      ];

      // Get theme colors
      const isCosmicTheme = document.body.classList.contains('cosmic-theme');
      const primaryColor = isCosmicTheme ? '#667eea' : '#f46b8a';
      const primaryColorHover = isCosmicTheme ? '#764ba2' : '#e64d6e';
      const gradientBg = isCosmicTheme 
        ? 'linear-gradient(135deg, #667eea, #764ba2)' 
        : 'linear-gradient(135deg, #f46b8a, #e64d6e)';
      const backdropColor = isCosmicTheme 
        ? 'rgba(102, 126, 234, 0.1)' 
        : 'rgba(244, 107, 138, 0.1)';

      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
        align-items: center; justify-content: center; backdrop-filter: blur(10px);
        animation: fadeIn 0.3s ease-out;
      `;

      const content = document.createElement('div');
      content.style.cssText = `
        background: rgba(255, 255, 255, 0.98); 
        backdrop-filter: blur(20px);
        border-radius: 25px; 
        padding: 35px; 
        max-width: 380px;
        width: 90%; 
        box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
        animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      `;

      content.innerHTML = `
        <style>
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
          }
          .share-modal-btn {
            display: block; 
            width: 100%;
            padding: 16px; 
            margin-bottom: 12px;
            text-decoration: none; 
            color: #333; 
            border: 2px solid ${primaryColor}; 
            border-radius: 15px;
            text-align: center; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-weight: 600;
            font-size: 15px;
            background: transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
          }
          .share-modal-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: ${gradientBg};
            transition: left 0.4s ease;
            z-index: -1;
          }
          .share-modal-btn:hover::before {
            left: 0;
          }
          .share-modal-btn:hover {
            color: white !important;
            border-color: transparent !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px ${backdropColor};
          }
          .close-modal-btn {
            width: 100%; 
            padding: 16px; 
            margin-top: 20px; 
            background: linear-gradient(135deg, #e0e0e0, #f5f5f5);
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 15px;
            color: #666;
            transition: all 0.3s ease;
          }
          .close-modal-btn:hover {
            background: linear-gradient(135deg, #d0d0d0, #e5e5e5);
            transform: translateY(-2px);
          }
        </style>
        <h3 style="margin: 0 0 25px 0; color: #333; text-align: center; font-size: 22px; font-weight: 700; background: ${gradientBg}; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
          –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø–æ–¥–∞—Ä–∫–æ–º
        </h3>
        <div style="display: flex; flex-direction: column; gap: 0;">
          ${shareOptions.map(option => `
            <a href="${option.url || '#'}" 
               data-action="${option.action || 'link'}"
               class="share-modal-btn"
               style="border-color: ${primaryColor};">
              ${option.name}
            </a>
          `).join('')}
        </div>
        <button onclick="this.closest('.share-modal').remove()" 
                class="close-modal-btn">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      `;

      modal.className = 'share-modal';
      modal.appendChild(content);
      document.body.appendChild(modal);

      // Handle copy link with theme-aware feedback
      content.addEventListener('click', (e) => {
        if (e.target.dataset.action === 'copy') {
          e.preventDefault();
          navigator.clipboard.writeText(window.location.href).then(() => {
            const originalText = e.target.textContent;
            e.target.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            e.target.style.background = isCosmicTheme 
              ? 'linear-gradient(135deg, #11998e, #38ef7d)' 
              : 'linear-gradient(135deg, #11998e, #38ef7d)';
            e.target.style.color = 'white';
            e.target.style.borderColor = 'transparent';
            
            setTimeout(() => {
              e.target.textContent = originalText;
              e.target.style.background = 'transparent';
              e.target.style.color = '#333';
              e.target.style.borderColor = primaryColor;
            }, 2500);
          });
        }
      });

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.animation = 'fadeOut 0.3s ease-out';
          content.style.animation = 'slideDown 0.3s ease-out';
          setTimeout(() => modal.remove(), 300);
        }
      });

      // Add fadeOut animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeOut {
          from { opacity: 1; }
          to { opacity: 0; }
        }
        @keyframes slideDown {
          from { opacity: 1; transform: translateY(0) scale(1); }
          to { opacity: 0; transform: translateY(30px) scale(0.9); }
        }
      `;
      document.head.appendChild(style);
    }

    // Enhanced download functionality
    document.getElementById('download-link').addEventListener('click', (e) => {
      e.preventDefault();
      
      const a = document.createElement('a');
      a.href = 'assets/song.mp3';
      a.download = 'my_personalized_birthday_song.mp3';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Success feedback
      const btn = e.target.closest('.download-btn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span>‚úÖ</span><span>–ó–∞–≥—Ä—É–∂–µ–Ω–æ!</span>';
      btn.style.background = 'linear-gradient(135deg, #11998e, #38ef7d)';
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = 'linear-gradient(135deg, #fbb47a, #f46b8a)';
      }, 3000);
    });

    // Initialize particles
    createParticles();

    // Initialize theme
    initializeTheme();

    // Keyboard shortcuts for better UX
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && isOpen) {
        e.preventDefault();
        playBtn.click();
      }
      if (e.code === 'Escape' && isOpen) {
        closeSongCard();
      }
      if (e.code === 'Enter' && !isOpen) {
        openBtn.click();
      }
    });

    // Add click to envelope for better UX
    document.getElementById('envelope').addEventListener('click', () => {
      if (!isOpen) {
        openBtn.click();
      }
    });

    // Prevent audio context issues on mobile
    document.addEventListener('touchstart', function() {
      if (audio.paused) {
        audio.play().then(() => {
          audio.pause();
        }).catch(() => {
          // Ignore errors on this initialization attempt
        });
      }
    }, { once: true });

    // Service Worker registration for better caching (optional)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {
          // Service worker registration failed, but app still works
        });
      });
    }

    // Add preload for better performance
    window.addEventListener('load', () => {
      // Preload audio
      if (audio.readyState < 3) {
        audio.load();
      }
      
      // Add slight delay to envelope animation start
      setTimeout(() => {
        document.getElementById('envelope').style.animationPlayState = 'running';
      }, 500);
    });

    // Error handling for audio
    audio.addEventListener('error', (e) => {
      console.error('Audio error:', e);
      playBtn.textContent = '‚ùå –§–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      playBtn.disabled = true;
      
      // Hide download button if audio fails
      document.getElementById('download-link').style.display = 'none';
    });

    // Progress indicator for audio loading
    audio.addEventListener('progress', () => {
      if (audio.buffered.length > 0) {
        const loaded = audio.buffered.end(0);
        const total = audio.duration;
        if (total > 0) {
          const progress = (loaded / total) * 100;
          if (progress < 100) {
            playBtn.textContent = `‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ ${Math.round(progress)}%`;
          } else {
            playBtn.textContent = '‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å –º–æ—é –ø–µ—Å–Ω—é';
          }
        }
      }
    });

    // Add visual feedback for button interactions
    [openBtn, playBtn, closeBtn].forEach(btn => {
      btn.addEventListener('mousedown', () => {
        btn.style.transform = btn.style.transform.replace('scale(1.05)', 'scale(0.98)');
      });
      
      btn.addEventListener('mouseup', () => {
        btn.style.transform = btn.style.transform.replace('scale(0.98)', 'scale(1.05)');
      });
    });

    // Analytics tracking (optional - remove if not needed)
    function trackEvent(action, category = 'Gift App') {
      if (typeof gtag !== 'undefined') {
        gtag('event', action, {
          'event_category': category,
          'event_label': window.location.pathname
        });
      }
    }

    // Track important user interactions
    openBtn.addEventListener('click', () => trackEvent('envelope_opened'));
    playBtn.addEventListener('click', () => trackEvent('song_played'));
    document.getElementById('download-link').addEventListener('click', () => trackEvent('song_downloaded'));
    document.getElementById('share-btn').addEventListener('click', () => trackEvent('gift_shared'));
  </script>
</body>
</html>
