<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –ó–∞–∫–∞–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–µ—Å–µ–Ω</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Floating musical notes -->
    <div class="floating-notes" id="floatingNotes"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">üéµ</div>
            <h1>–°–æ–∑–¥–∞–µ–º –≤–∞—à—É —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ø–µ—Å–Ω—é</h1>
            <p>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –æ—Å–æ–±—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</p>
        </div>

        <!-- Features -->
        <div class="features">
            <div class="feature-card">
                <span class="feature-icon">üé§</span>
                <div class="feature-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã</div>
                <div class="feature-description">–ö–∞–∂–¥–∞—è –ø–µ—Å–Ω—è —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å —Å —É—á–µ—Ç–æ–º –≤–∞—à–∏—Ö –ø–æ–∂–µ–ª–∞–Ω–∏–π</div>
            </div>
            <div class="feature-card">
                <span class="feature-icon">üéº</span>
                <div class="feature-title">–õ—é–±–æ–π –∂–∞–Ω—Ä</div>
                <div class="feature-description">–û—Ç —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–ª–ª–∞–¥ –¥–æ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–≥–æ —Ä—ç–ø–∞ - –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç–∏–ª—å</div>
            </div>
            <div class="feature-card">
                <span class="feature-icon">‚ö°</span>
                <div class="feature-title">–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</div>
                <div class="feature-description">–ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–Ω–µ–π</div>
            </div>
        </div>

        <!-- Main Application -->
        <div class="main-card">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 25%"></div>
            </div>

            <!-- Step 1: Promo Code -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥</h2>
                    <p class="step-description">–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –∑–∞–∫–∞–∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø–µ—Å–Ω–∏? –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ</p>
                </div>

                <form id="promoForm">
                    <div class="form-group">
                        <label class="form-label">üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥</label>
                        <div class="promo-input-container">
                            <input 
                                type="text" 
                                class="form-input promo-input" 
                                id="promoCode" 
                                placeholder="MUSIC2024"
                                maxlength="20"
                                required
                            >
                            <span class="promo-icon">üîë</span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="promoSubmitBtn">
                            –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Song Request -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π –ø–µ—Å–Ω–µ</h2>
                    <p class="step-description">–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤—ã –æ–ø–∏—à–µ—Ç–µ, —Ç–µ–º –ª—É—á—à–µ –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>

                <form id="songRequestForm">
                    <div class="form-group">
                        <label class="form-label">üë§ –î–ª—è –∫–æ–≥–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–µ—Å–Ω—è?</label>
                        <input 
                            type="text" 
                            class="form-input" 
                            id="songRecipient" 
                            placeholder="–î–ª—è –∂–µ–Ω—ã, —Å—ã–Ω–∞, –∫–æ–ª–ª–µ–≥ –ø–æ —Ä–∞–±–æ—Ç–µ..."
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">üé≠ –ö–∞–∫–æ–π –∂–∞–Ω—Ä/—Å—Ç–∏–ª—å –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?</label>
                        <input 
                            type="text" 
                            class="form-input" 
                            id="songGenre" 
                            placeholder="–ü–æ–ø, —Ä–æ–∫, —Ä—ç–ø, –±–∞–ª–ª–∞–¥–∞, –Ω–∞—Ä–æ–¥–Ω–∞—è..."
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìù –û —á–µ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Å–Ω—è?</label>
                        <textarea 
                            class="form-textarea" 
                            id="songTheme" 
                            placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é, –ø–æ–≤–æ–¥, —ç–º–æ—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å..."
                            required
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚ú® –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea 
                            class="form-textarea" 
                            id="songWishes" 
                            placeholder="–£–ø–æ–º—è–Ω—É—Ç—å –∏–º–µ–Ω–∞, –¥–∞—Ç—ã, –º–µ—Å—Ç–∞, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã..."
                            style="min-height: 100px;"
                        ></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="songSubmitBtn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: Order Summary -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h2 class="step-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
                    <p class="step-description">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞</p>
                </div>

                <div class="order-summary">
                    <h3>üìã –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
                    <div class="order-detail">
                        <strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> <span id="orderNumber"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–ü—Ä–æ–º–æ–∫–æ–¥:</strong> <span id="summaryPromo"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> <span id="summaryRecipient"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–ñ–∞–Ω—Ä:</strong> <span id="summaryGenre"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–¢–µ–º–∞:</strong> <span id="summaryTheme"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–ü–æ–∂–µ–ª–∞–Ω–∏—è:</strong> <span id="summaryWishes"></span>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                        ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmOrder()">
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div class="step" id="step4">
                <div class="success-animation">
                    <div class="success-icon">üéâ</div>
                    <h2 class="step-title">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</h2>
                    <p class="step-description">
                        –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏, –∫–æ–≥–¥–∞ –ø–µ—Å–Ω—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let GOOGLE_SHEETS_CONFIG = {
            API_KEY: '',
            SPREADSHEET_ID: '',
            SHEETS: { 
                PROMO_CODES: 'PromoCodes', 
                ORDERS: 'Orders', 
                USERS: 'Users' 
            }
        };

        let currentStep = 1;
        let orderData = {};

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ API
        async function fetchEnvConfig() {
            try {
                console.log('Fetching configuration...');
                const res = await fetch('/api/env');
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                console.log('Configuration loaded:', { 
                    hasApiKey: !!data.GOOGLE_SHEETS_API_KEY, 
                    hasSpreadsheetId: !!data.GOOGLE_SPREADSHEET_ID 
                });
                
                return data;
            } catch (error) {
                console.error('Error fetching config:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'error');
                return { 
                    GOOGLE_SHEETS_API_KEY: '', 
                    GOOGLE_SPREADSHEET_ID: '' 
                };
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('App initializing...');
            
            try {
                const env = await fetchEnvConfig();
                GOOGLE_SHEETS_CONFIG.API_KEY = env.GOOGLE_SHEETS_API_KEY;
                GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID = env.GOOGLE_SPREADSHEET_ID;

                if (!GOOGLE_SHEETS_CONFIG.API_KEY || !GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID) {
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è', 'error');
                    console.error('Missing configuration');
                    return;
                }

                setupFloatingNotes();
                setupEventListeners();
                updateProgress();
                
                showNotification('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
            }
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–≤–∞—é—â–∏—Ö –Ω–æ—Ç
        function setupFloatingNotes() {
            const container = document.getElementById('floatingNotes');
            const notes = ['‚ô™', '‚ô´', '‚ô¨', 'ùÑû', 'ùÑ¢'];
            
            function createNote() {
                const note = document.createElement('div');
                note.className = 'floating-note';
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                note.style.left = Math.random() * 100 + '%';
                note.style.animationDuration = (Math.random() * 3 + 2) + 's';
                note.style.fontSize = (Math.random() * 10 + 15) + 'px';
                note.style.opacity = Math.random() * 0.7 + 0.3;
                
                container.appendChild(note);
                
                setTimeout(() => {
                    if (note.parentNode) {
                        note.parentNode.removeChild(note);
                    }
                }, 5000);
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ—Ç—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏
            setInterval(createNote, 2000);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ü—Ä–æ–º–æ–∫–æ–¥ —Ñ–æ—Ä–º–∞
            const promoForm = document.getElementById('promoForm');
            if (promoForm) {
                promoForm.addEventListener('submit', handlePromoSubmit);
            }

            // –§–æ—Ä–º–∞ –∑–∞–∫–∞–∑–∞ –ø–µ—Å–Ω–∏
            const songForm = document.getElementById('songRequestForm');
            if (songForm) {
                songForm.addEventListener('submit', handleSongSubmit);
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
            const inputs = document.querySelectorAll('.form-input, .form-textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updateProgress);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        async function handlePromoSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('promoSubmitBtn');
            const promoCode = document.getElementById('promoCode').value.trim();
            
            if (!promoCode) {
                showNotification('‚ùå –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
                
                const isValid = await validatePromoCode(promoCode);
                
                if (isValid) {
                    orderData.promoCode = promoCode;
                    showNotification('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
                    goToStep(2);
                } else {
                    showNotification('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω', 'error');
                }
                
            } catch (error) {
                console.error('Promo validation error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø–µ—Å–Ω–∏
        async function handleSongSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('songSubmitBtn');
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...';
                
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                orderData.recipient = document.getElementById('songRecipient').value.trim();
                orderData.genre = document.getElementById('songGenre').value.trim();
                orderData.theme = document.getElementById('songTheme').value.trim();
                orderData.wishes = document.getElementById('songWishes').value.trim();
                orderData.timestamp = new Date().toISOString();
                orderData.orderNumber = generateOrderNumber();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                if (!orderData.recipient || !orderData.genre || !orderData.theme) {
                    showNotification('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—é
                fillOrderSummary();
                goToStep(3);
                
            } catch (error) {
                console.error('Song form error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑';
            }
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ —á–µ—Ä–µ–∑ Google Sheets (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
        async function validatePromoCode(code) {
            try {
                if (!GOOGLE_SHEETS_CONFIG.API_KEY || !GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID) {
                    console.error('Missing Google Sheets configuration');
                    return false;
                }

                const sheetName = GOOGLE_SHEETS_CONFIG.SHEETS.PROMO_CODES;
                const range = `${sheetName}!A:G`; // A=–ü—Ä–æ–º–æ–∫–æ–¥, B=–°—Ç–∞—Ç—É—Å, C=–û–ø–∏—Å–∞–Ω–∏–µ, D=–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π, E=–ú–∞–∫—Å–∏–º—É–º, F=–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, G=–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID}/values/${range}?key=${GOOGLE_SHEETS_CONFIG.API_KEY}`;
                
                console.log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥:', code);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    console.error('Google Sheets API error:', response.status);
                    // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
                    const fallbackCodes = ['MUSIC2024', 'SONG2024', 'TEST', 'DEMO', 'VIP2024'];
                    return fallbackCodes.includes(code.toUpperCase());
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É');
                    const fallbackCodes = ['MUSIC2024', 'SONG2024', 'TEST', 'DEMO', 'VIP2024'];
                    return fallbackCodes.includes(code.toUpperCase());
                }
                
                // –ò—â–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –≤ —Ç–∞–±–ª–∏—Ü–µ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫)
                for (let i = 1; i < data.values.length; i++) {
                    const row = data.values[i];
                    const promoCode = row[0] ? row[0].toString().toUpperCase() : '';
                    const status = row[1] ? row[1].toString().toLowerCase() : '';
                    const description = row[2] ? row[2].toString() : '';
                    const usageCount = parseInt(row[3]) || 0;
                    const maxUsage = parseInt(row[4]) || 0;
                    
                    if (promoCode === code.toUpperCase()) {
                        console.log('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞–π–¥–µ–Ω:', { promoCode, status, description, usageCount, maxUsage });
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                        if (status !== '–∞–∫—Ç–∏–≤–µ–Ω' && status !== 'active') {
                            showNotification(`‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ ${status}`, 'error');
                            return false;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π
                        if (maxUsage > 0 && usageCount >= maxUsage) {
                            showNotification('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω', 'error');
                            return false;
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–º–æ–∫–æ–¥–µ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                        orderData.promoCodeInfo = {
                            code: promoCode,
                            description: description,
                            usageCount: usageCount,
                            maxUsage: maxUsage
                        };
                        
                        return true;
                    }
                }
                
                console.log('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ');
                showNotification('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return false;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', error);
                // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                const fallbackCodes = ['MUSIC2024', 'SONG2024', 'TEST', 'DEMO', 'VIP2024'];
                const isValid = fallbackCodes.includes(code.toUpperCase());
                console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:', isValid);
                if (!isValid) {
                    showNotification('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω', 'error');
                }
                return isValid;
            }
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –∑–∞–∫–∞–∑–∞
        function fillOrderSummary() {
            document.getElementById('orderNumber').textContent = orderData.orderNumber;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å
            let promoText = orderData.promoCode;
            if (orderData.promoCodeInfo && orderData.promoCodeInfo.description) {
                promoText += ` (${orderData.promoCodeInfo.description})`;
            }
            document.getElementById('summaryPromo').textContent = promoText;
            
            document.getElementById('summaryRecipient').textContent = orderData.recipient;
            document.getElementById('summaryGenre').textContent = orderData.genre;
            document.getElementById('summaryTheme').textContent = orderData.theme.length > 100 
                ? orderData.theme.substring(0, 100) + '...' 
                : orderData.theme;
                
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∂–µ–ª–∞–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å
            const wishesElement = document.getElementById('summaryWishes');
            if (wishesElement) {
                if (orderData.wishes && orderData.wishes.trim()) {
                    wishesElement.textContent = orderData.wishes.length > 80 
                        ? orderData.wishes.substring(0, 80) + '...' 
                        : orderData.wishes;
                    wishesElement.parentElement.style.display = 'flex';
                } else {
                    wishesElement.parentElement.style.display = 'none';
                }
            }
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ Google Sheets
        async function confirmOrder() {
            try {
                showNotification('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑...', 'info');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ Google Sheets
                const success = await saveOrderToSheets(orderData);
                
                if (success) {
                    showNotification('‚úÖ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                    goToStep(4);
                } else {
                    showNotification('‚ö†Ô∏è –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É', 'info');
                    goToStep(4);
                }
                
            } catch (error) {
                console.error('Order confirmation error:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞', 'error');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –≤ Google Sheets (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
        async function saveOrderToSheets(data) {
            try {
                if (!GOOGLE_SHEETS_CONFIG.API_KEY || !GOOGLE_SHEETS_CONFIG.SPREADSHEET_ID) {
                    console.error('Missing Google Sheets configuration');
                    return false;
                }

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º UserID (–ø—Ä–æ—Å—Ç–æ–π —Ö–µ—à –æ—Ç –≤—Ä–µ–º–µ–Ω–∏)
                const userId = 'USER_' + Date.now().toString(36).toUpperCase();
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ:
                // ID | UserID | –ö–æ–Ω—Ç–∞–∫—Ç | –ò–º—è | –ü—Ä–æ–º–æ–∫–æ–¥ | –ü–æ–ª—É—á–∞—Ç–µ–ª—å | –ñ–∞–Ω—Ä | –¢–µ–º–∞ | –ü–æ–∂–µ–ª–∞–Ω–∏—è | –î–∞—Ç–∞ | –í—Ä–µ–º—è | –°—Ç–∞—Ç—É—Å
                const now = new Date();
                const dateStr = now.toLocaleDateString('ru-RU');
                const timeStr = now.toLocaleTimeString('ru-RU');
                
                const orderRow = [
                    data.orderNumber,           // ID
                    userId,                     // UserID
                    '',                         // –ö–æ–Ω—Ç–∞–∫—Ç (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–π)
                    '',                         // –ò–º—è (–ø–æ–∫–∞ –ø—É—Å—Ç–æ–µ)
                    data.promoCode,             // –ü—Ä–æ–º–æ–∫–æ–¥
                    data.recipient,             // –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                    data.genre,                 // –ñ–∞–Ω—Ä
                    data.theme,                 // –¢–µ–º–∞
                    data.wishes || '',          // –ü–æ–∂–µ–ª–∞–Ω–∏—è
                    dateStr,                    // –î–∞—Ç–∞
                    timeStr,                    // –í—Ä–µ–º—è
                    '–ù–æ–≤—ã–π'                     // –°—Ç–∞—Ç—É—Å
                ];

                // –õ–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
                console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', {
                    orderNumber: data.orderNumber,
                    userId: userId,
                    promoCode: data.promoCode,
                    recipient: data.recipient,
                    genre: data.genre,
                    theme: data.theme.substring(0, 50) + '...',
                    date: dateStr,
                    time: timeStr
                });
                
                // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Google Apps Script –∏–ª–∏ –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥
                // Google Sheets API —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è, –∑–∞–ø–∏—Å—å —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                
                // –ò–º–∏—Ç–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ email –∏–ª–∏ webhook
                console.log('–ó–∞–∫–∞–∑ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ:', orderRow);
                
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
                return false;
            }
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
        function goToStep(step) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —à–∞–≥
            const targetStep = document.getElementById(`step${step}`);
            if (targetStep) {
                targetStep.classList.add('active');
                currentStep = step;
                updateProgress();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress() {
            const progressBar = document.getElementById('progressBar');
            const progress = (currentStep / 4) * 100;
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
        function generateOrderNumber() {
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `MS${timestamp}${random}`;
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showNotification('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        });
    </script>

    <style>
        .floating-note {
            position: fixed;
            top: -20px;
            color: rgba(255, 255, 255, 0.1);
            font-size: 20px;
            animation: float-down linear infinite;
            pointer-events: none;
            z-index: 1;
        }

        @keyframes float-down {
            from {
                transform: translateY(-20px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #10b981;
            color: white;
        }

        .notification.error {
            background: #ef4444;
            color: white;
        }

        .notification.info {
            background: #3b82f6;
            color: white;
        }
    </style>
</body>
</html>
