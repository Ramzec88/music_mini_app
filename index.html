<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –ó–∞–∫–∞–∑ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –ø–µ—Å–µ–Ω</title>
    <style>
        @keyframes rainbow {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .connection-status.online {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
        }
        
        .connection-status.offline {
            background: linear-gradient(45deg, #f56565, #e53e3e);
            color: white;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .floating-notes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .note {
            position: absolute;
            font-size: 2rem;
            opacity: 0.1;
            animation: float 15s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.1;
            }
            90% {
                opacity: 0.1;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            font-size: 4rem;
            margin-bottom: 20px;
            display: inline-block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .header h1 {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.3);
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
            animation: slideUp 0.8s ease-out 0.3s both;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .step-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-number {
            display: inline-block;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 50px;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .step-title {
            font-size: 1.8rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .step-description {
            color: #718096;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #4a5568;
            font-size: 1.1rem;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 15px 20px;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1);
            background: white;
            transform: translateY(-2px);
        }

        .form-textarea {
            resize: vertical;
            min-height: 150px;
            line-height: 1.6;
        }

        .promo-input-container {
            position: relative;
        }

        .promo-input {
            padding-right: 60px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: bold;
            text-align: center;
        }

        .promo-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #a0aec0;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(45deg, #48bb78, #38a169);
            color: white;
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        .success-animation {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            font-size: 5rem;
            color: #48bb78;
            margin-bottom: 20px;
            animation: successBounce 0.6s ease-out;
        }

        @keyframes successBounce {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .order-summary {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #667eea;
        }

        .order-summary h3 {
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .order-detail {
            margin-bottom: 10px;
            color: #718096;
            line-height: 1.5;
        }

        .order-detail strong {
            color: #4a5568;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: transform 0.3s ease;
            animation: slideUp 0.8s ease-out;
        }

        .feature-card:hover {
            transform: translateY(-10px);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        .feature-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .feature-description {
            color: #718096;
            line-height: 1.5;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(45deg, #48bb78, #38a169);
        }

        .notification.error {
            background: linear-gradient(45deg, #f56565, #e53e3e);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .tips {
            background: linear-gradient(45deg, #ffd89b, #19547b);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .tips h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tips ul {
            list-style: none;
            padding-left: 0;
        }

        .tips li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 25px;
        }

        .tips li::before {
            content: '‚ú®';
            position: absolute;
            left: 0;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            /* –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω */
            cursor: pointer;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 85vh; /* –£–º–µ–Ω—å—à–∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É */
            overflow-y: auto;
            /* –£–±–∏—Ä–∞–µ–º –∫—É—Ä—Å–æ—Ä pointer –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
            cursor: default;
        }

        .modal-header {
            padding: 15px 20px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø—ã */
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            z-index: 1;
        }

        .modal-title {
            margin: 0;
            color: #4a5568;
            font-size: 1.2rem; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∏–ª–∏ */
        }

        .close-btn {
            background: #f56565;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #e53e3e;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .main-card {
                padding: 25px;
                border-radius: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .logo {
                font-size: 3rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Floating musical notes -->
    <div class="floating-notes" id="floatingNotes"></div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">üéµ</div>
            <h1>–°–æ–∑–¥–∞–µ–º –≤–∞—à—É —É–Ω–∏–∫–∞–ª—å–Ω—É—é –ø–µ—Å–Ω—é</h1>
            <p>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –æ—Å–æ–±—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</p>
        </div>

        <!-- Features -->
        <div class="features">
            <div class="feature-card">
                <span class="feature-icon">üé§</span>
                <div class="feature-title">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã</div>
                <div class="feature-description">–ö–∞–∂–¥–∞—è –ø–µ—Å–Ω—è —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –≤–∞—Å —Å —É—á–µ—Ç–æ–º –≤–∞—à–∏—Ö –ø–æ–∂–µ–ª–∞–Ω–∏–π</div>
            </div>
            <div class="feature-card">
                <span class="feature-icon">üéº</span>
                <div class="feature-title">–õ—é–±–æ–π –∂–∞–Ω—Ä</div>
                <div class="feature-description">–û—Ç —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏—Ö –±–∞–ª–ª–∞–¥ –¥–æ —ç–Ω–µ—Ä–≥–∏—á–Ω–æ–≥–æ —Ä—ç–ø–∞ - –≤—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç–∏–ª—å</div>
            </div>
            <div class="feature-card">
                <span class="feature-icon">‚ö°</span>
                <div class="feature-title">–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ</div>
                <div class="feature-description">–ü–æ–ª—É—á–∏—Ç–µ –≥–æ—Ç–æ–≤—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–Ω–µ–π</div>
            </div>
        </div>

        <!-- Main Application -->
        <div class="main-card">
            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 25%"></div>
            </div>

            <!-- Step 1: Promo Code -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥</h2>
                    <p class="step-description">–£ –≤–∞—Å –µ—Å—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –∑–∞–∫–∞–∑–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø–µ—Å–Ω–∏? –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ</p>
                </div>

                <form id="promoForm">
                    <div class="form-group">
                        <label class="form-label">üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥</label>
                        <div class="promo-input-container">
                            <input 
                                type="text" 
                                class="form-input promo-input" 
                                id="promoCode" 
                                placeholder="MUS-RL6036"
                                maxlength="15"
                                required
                            >
                            <span class="promo-icon">üîë</span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" id="promoSubmitBtn">
                            –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Song Request -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π –ø–µ—Å–Ω–µ</h2>
                    <p class="step-description">–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤—ã –æ–ø–∏—à–µ—Ç–µ, —Ç–µ–º –ª—É—á—à–µ –±—É–¥–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç</p>
                </div>

                <form id="songRequestForm">
                    <div class="form-group">
                        <label class="form-label">üë§ –î–ª—è –∫–æ–≥–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –ø–µ—Å–Ω—è?</label>
                        <input 
                            type="text" 
                            class="form-input" 
                            id="songRecipient" 
                            placeholder="–î–ª—è –∂–µ–Ω—ã, —Å—ã–Ω–∞, –∫–æ–ª–ª–µ–≥ –ø–æ —Ä–∞–±–æ—Ç–µ..."
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">üé≠ –ö–∞–∫–æ–π –∂–∞–Ω—Ä/—Å—Ç–∏–ª—å –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ?</label>
                        <input 
                            type="text" 
                            class="form-input" 
                            id="songGenre" 
                            placeholder="–ü–æ–ø, —Ä–æ–∫, —Ä—ç–ø, –±–∞–ª–ª–∞–¥–∞, –Ω–∞—Ä–æ–¥–Ω–∞—è..."
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìù –û —á–µ–º –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Å–Ω—è?</label>
                        <textarea 
                            class="form-textarea" 
                            id="songTheme" 
                            placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é, –ø–æ–≤–æ–¥, —ç–º–æ—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–¥–∞—Ç—å..."
                            required
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‚ú® –û—Å–æ–±—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea 
                            class="form-textarea" 
                            id="songWishes" 
                            placeholder="–£–ø–æ–º—è–Ω—É—Ç—å –∏–º–µ–Ω–∞, –¥–∞—Ç—ã, –º–µ—Å—Ç–∞, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ—Ä–∞–∑—ã..."
                            style="min-height: 100px;"
                        ></textarea>
                    </div>

                    <div class="tips">
                        <h4>üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:</h4>
                        <ul>
                            <li>–£–∫–∞–∂–∏—Ç–µ –ø–æ–≤–æ–¥ (–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, —Å–≤–∞–¥—å–±–∞, —é–±–∏–ª–µ–π)</li>
                            <li>–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–µ —á–µ–ª–æ–≤–µ–∫–∞</li>
                            <li>–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∏–ª–∏ –æ–±—â–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è</li>
                            <li>–£–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–µ—Å–Ω–∏</li>
                            <li>–£–ø–æ–º—è–Ω–∏—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∏ –¥–∞—Ç—ã</li>
                        </ul>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                        <button type="submit" class="btn btn-primary" id="songSubmitBtn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: Order Summary -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h2 class="step-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h2>
                    <p class="step-description">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞</p>
                </div>

                <div class="order-summary">
                    <h3>üìã –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h3>
                    <div class="order-detail">
                        <strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong> <span id="orderNumberPreview">–ë—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω</span>
                    </div>
                    <div class="order-detail">
                        <strong>–ü—Ä–æ–º–æ–∫–æ–¥:</strong> <span id="summaryPromo"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> <span id="summaryRecipient"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–ñ–∞–Ω—Ä:</strong> <span id="summaryGenre"></span>
                    </div>
                    <div class="order-detail">
                        <strong>–¢–µ–º–∞:</strong> <span id="summaryTheme"></span>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                        ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å
                    </button>
                    <button type="button" class="btn btn-success" onclick="confirmOrder()">
                        ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
                    </button>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div class="step" id="step4">
                <div class="success-animation">
                    <div class="success-icon">üéâ</div>
                    <h2 class="step-title">–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</h2>
                    <p class="step-description">
                        –í–∞—à –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏, –∫–æ–≥–¥–∞ –ø–µ—Å–Ω—è –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞.
                    </p>
                    
                    <!-- –í—ã–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ -->
                    <div style="text-align: center; margin: 25px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.1rem; opacity: 0.9;">–ù–æ–º–µ—Ä –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞:</h3>
                        <div style="font-size: 2rem; font-weight: bold; font-family: monospace; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); cursor: pointer;" 
                             id="orderNumber" 
                             onclick="copyOrderNumber()"
                             title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">
                            #–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
                        </div>
                        <p style="margin: 15px 0 0 0; font-size: 0.9rem; opacity: 0.8;">
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞<br>
                            <small>üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</small>
                        </p>
                    </div>
                    
                    <div class="order-summary">
                        <h3>üìß –ß—Ç–æ –¥–∞–ª—å—à–µ?</h3>
                        <div class="order-detail">
                            ‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –ø–µ—Ä–µ–¥–∞–Ω –∫–æ–º–ø–æ–∑–∏—Ç–æ—Ä—É
                        </div>
                        <div class="order-detail">
                            üéµ –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Å–Ω–∏ –∑–∞–π–º–µ—Ç 2-5 –¥–Ω–µ–π
                        </div>
                        <div class="order-detail">
                            üì± –ì–æ—Ç–æ–≤–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–∞–º –≤ Telegram
                        </div>
                        <div class="order-detail">
                            ‚≠ê –ß–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –º—ã –ø–æ–ø—Ä–æ—Å–∏–º –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="createNewOrder()">
                            üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Status Check - –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –∫–æ–Ω–µ—Ü, –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    </div>

    <!-- –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –±–ª–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ -->
    <div class="container">
        <div class="main-card" style="margin-top: 20px;">
            <h3 style="text-align: center; margin-bottom: 20px; color: #4a5568;">
                üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
            </h3>
            <p style="text-align: center; margin-bottom: 25px; color: #718096; line-height: 1.5;">
                –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –ø–æ—Å–ª–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            </p>
            <div class="form-group">
                <label class="form-label" style="text-align: center;">–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ORD123456)</label>
                <input 
                    type="text" 
                    class="form-input" 
                    id="orderCheckId" 
                    placeholder="ORD123456"
                    style="text-align: center; font-family: monospace; font-weight: bold; letter-spacing: 1px;"
                    maxlength="12"
                >
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="checkOrderStatus()">
                    üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                </button>
            </div>
            
            <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9ff; border-radius: 10px; border-left: 4px solid #667eea;">
                <p style="margin: 0; color: #4a5568; font-size: 0.95rem;">
                    <strong>üí° –ì–¥–µ –Ω–∞–π—Ç–∏ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞?</strong><br>
                    –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç ORD + 6 —Ü–∏—Ñ—Ä
                </p>
            </div>
        </div>
    </div>

    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ API —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Telegram
        async function makeAPIRequest(action, params) {
            try {
                console.log(`üì° API –∑–∞–ø—Ä–æ—Å: ${action}`, params);
                
                // –û—Å–æ–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è Telegram WebApp
                const isInTelegram = window.Telegram && window.Telegram.WebApp;
                
                const requestOptions = {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è Telegram
                        ...(isInTelegram && {
                            'X-Requested-With': 'TelegramWebApp',
                            'Cache-Control': 'no-cache'
                        })
                    },
                    body: JSON.stringify({ action, ...params })
                };

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout –¥–ª—è Telegram
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), isInTelegram ? 15000 : 10000);
                
                requestOptions.signal = controller.signal;

                console.log(`üîó –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å${isInTelegram ? ' —á–µ—Ä–µ–∑ Telegram' : ''} –Ω–∞ /api/sheets`);
                
                const response = await fetch('/api/sheets', requestOptions);
                
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`‚úÖ API –æ—Ç–≤–µ—Ç:`, data);
                return data;
                
            } catch (error) {
                console.error('‚ùå API –æ—à–∏–±–∫–∞:', error);
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è Telegram
                if (error.name === 'AbortError') {
                    throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                if (error.message.includes('Failed to fetch')) {
                    if (window.Telegram && window.Telegram.WebApp) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –≤ Telegram. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
                    }
                }
                
                throw error;
            }
        }

        async function findRowByValue(sheetName, searchValue) {
            try {
                const data = await makeAPIRequest('find', { sheetName, searchValue });
                return data.found ? { rowIndex: data.rowIndex, rowData: data.rowData } : null;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ findRowByValue:', error);
                return null;
            }
        }

        async function updateCell(sheetName, cell, newValue) {
            try {
                return await makeAPIRequest('update', { sheetName, cell, newValue });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ updateCell:', error);
                return null;
            }
        }

        async function appendToSheet(sheetName, values) {
            try {
                return await makeAPIRequest('append', { sheetName, values });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ appendToSheet:', error);
                return null;
            }
        }

        async function validatePromoCode(promoCode) {
            console.log('üéüÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞:', promoCode);
            
            const result = await findRowByValue('PromoCodes', promoCode);
            console.log('üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞:', result);
            
            if (!result) {
                console.log('‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ');
                return { valid: false, message: '–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω' };
            }

            const [code, status = '', description = '', uses = '0', maxUses = '1'] = result.rowData;
            console.log('üìä –î–∞–Ω–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', { code, status, description, uses, maxUses });
            
            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç–∞—Ç—É—Å
            const normalizedStatus = String(status).trim().toLowerCase();
            console.log('üîÑ –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å:', normalizedStatus);
            
            if (normalizedStatus !== 'active') {
                console.log('‚ùå –°—Ç–∞—Ç—É—Å –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω:', status);
                return { valid: false, message: `–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω (—Å—Ç–∞—Ç—É—Å: "${status}")` };
            }

            const currentUses = parseInt(uses || '0', 10);
            const maxUsesLimit = parseInt(maxUses || '1', 10);
            console.log('üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:', { currentUses, maxUsesLimit });

            if (currentUses >= maxUsesLimit) {
                return { valid: false, message: '–ü—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' };
            }

            return { 
                valid: true, 
                message: '–ü—Ä–æ–º–æ–∫–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω',
                description, 
                rowIndex: result.rowIndex, 
                currentUses, 
                maxUsesLimit 
            };
        }

        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Telegram
        function showNotification(message, type = 'success') {
            console.log(`${type.toUpperCase()}: ${message}`);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                const version = parseFloat(tg.version || '6.0');
                
                // –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert
                if (type === 'error') {
                    try {
                        tg.showAlert(message);
                    } catch (e) {
                        console.warn('Telegram showAlert –æ—à–∏–±–∫–∞:', e);
                        showBrowserNotification(message, type);
                    }
                    return;
                }
                
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ —Å –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
                console.log(`üì± Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–≤–µ—Ä—Å–∏—è ${version}): ${message}`);
                showBrowserNotification(message, type);
                return;
            }

            // –û–±—ã—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞
            showBrowserNotification(message, type);
        }

        function showBrowserNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (notification) {
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentStep = 1;
        let orderData = {};
        let currentOrderId = null;
        let telegramApp = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –º–µ—Ç–æ–¥–æ–≤ Telegram
        function checkTelegramSupport() {
            if (!window.Telegram || !window.Telegram.WebApp) {
                return { supported: false, version: null, methods: [] };
            }
            
            const tg = window.Telegram.WebApp;
            const version = parseFloat(tg.version || '6.0');
            const supportedMethods = [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            if (typeof tg.showAlert === 'function') supportedMethods.push('showAlert');
            if (typeof tg.showPopup === 'function') supportedMethods.push('showPopup');
            if (typeof tg.showConfirm === 'function') supportedMethods.push('showConfirm');
            if (typeof tg.showScanQrPopup === 'function') supportedMethods.push('showScanQrPopup');
            
            console.log(`üì± Telegram WebApp –ø–æ–¥–¥–µ—Ä–∂–∫–∞:`, {
                version: version,
                supportedMethods: supportedMethods
            });
            
            return {
                supported: true,
                version: version,
                methods: supportedMethods
            };
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                telegramApp = window.Telegram.WebApp;
                telegramApp.expand();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã
                const support = checkTelegramSupport();
                console.log(`üì± Telegram Web App –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –≤–µ—Ä—Å–∏—è: ${support.version}`);
                console.log(`üîß –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –º–µ—Ç–æ–¥—ã: ${support.methods.join(', ')}`);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const user = telegramApp.initDataUnsafe?.user;
                if (user) {
                    console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Telegram:', user);
                    localStorage.setItem('tg_user', JSON.stringify({
                        id: user.id,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        username: user.username
                    }));
                }
            }
            
            setupFloatingNotes();
            setupEventListeners();
            updateProgress();
            testGoogleSheetsConnection();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            setTimeout(restoreFormData, 1000);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–±–µ–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
            setTimeout(addConnectionStatus, 2000);
            
            console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞ —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        function setupEventListeners() {
            document.getElementById('promoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitPromoCode();
            });
            
            document.getElementById('songRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitSongRequest();
            });
            
            // –£–ª—É—á—à–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ —Å —Ç–∏—Ä–µ
            document.getElementById('promoCode').addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase();
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –±—É–∫–≤, —Ü–∏—Ñ—Ä –∏ —Ç–∏—Ä–µ
                value = value.replace(/[^A-Z0-9\-]/g, '');
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
                if (value.length > 15) value = value.slice(0, 15);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ MUS-XXXXXX
                if (value.length >= 3 && !value.includes('-')) {
                    // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ 3+ —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ —Ç–∏—Ä–µ, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∏—Ä–µ –ø–æ—Å–ª–µ MUS
                    if (value.startsWith('MUS') && value.length > 3) {
                        value = 'MUS-' + value.slice(3);
                    }
                }
                
                e.target.value = value;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ —Ñ–æ—Ä–º–∞—Ç–µ
                updatePromoCodeHint(value);
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
            document.getElementById('orderCheckId').addEventListener('input', function(e) {
                let value = e.target.value.toUpperCase();
                
                // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä
                value = value.replace(/[^A-Z0-9]/g, '');
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ORD + —Ü–∏—Ñ—Ä—ã
                if (value.length > 0 && !value.startsWith('ORD')) {
                    if (/^\d/.test(value)) {
                        // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã, –¥–æ–±–∞–≤–ª—è–µ–º ORD
                        value = 'ORD' + value;
                    }
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É (ORD + 6 —Ü–∏—Ñ—Ä = 9 —Å–∏–º–≤–æ–ª–æ–≤)
                if (value.length > 9) value = value.slice(0, 9);
                
                e.target.value = value;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                updateOrderIdHint(value);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ —Ñ–æ—Ä–º–∞—Ç–µ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
        function updateOrderIdHint(value) {
            let hintElement = document.getElementById('orderIdHint');
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!hintElement) {
                hintElement = document.createElement('div');
                hintElement.id = 'orderIdHint';
                hintElement.style.cssText = `
                    font-size: 0.9rem;
                    margin-top: 8px;
                    padding: 8px 12px;
                    border-radius: 8px;
                    transition: all 0.3s ease;
                `;
                
                const orderCheckContainer = document.getElementById('orderCheckId').parentNode;
                orderCheckContainer.appendChild(hintElement);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç ORD + 6 —Ü–∏—Ñ—Ä
            const isValidFormat = /^ORD\d{6}$/.test(value);
            const isPartialFormat = /^ORD\d{0,6}$/.test(value);
            
            if (value === '') {
                hintElement.style.display = 'none';
            } else if (isValidFormat) {
                hintElement.innerHTML = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞';
                hintElement.style.backgroundColor = '#f0fff4';
                hintElement.style.color = '#38a169';
                hintElement.style.border = '1px solid #9ae6b4';
                hintElement.style.display = 'block';
            } else if (isPartialFormat && value.length < 9) {
                hintElement.innerHTML = 'üí° –§–æ—Ä–º–∞—Ç: ORD000000 (–Ω–∞–ø—Ä–∏–º–µ—Ä, ORD123456)';
                hintElement.style.backgroundColor = '#fffbf0';
                hintElement.style.color = '#d69e2e';
                hintElement.style.border = '1px solid #fbd38d';
                hintElement.style.display = 'block';
            } else {
                hintElement.innerHTML = '‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –û–∂–∏–¥–∞–µ—Ç—Å—è: ORD000000';
                hintElement.style.backgroundColor = '#fff5f5';
                hintElement.style.color = '#e53e3e';
                hintElement.style.border = '1px solid #feb2b2';
                hintElement.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ —Ñ–æ—Ä–º–∞—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        function updatePromoCodeHint(value) {
            let hintElement = document.getElementById('promoCodeHint');
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–∫–∞–∑–∫–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!hintElement) {
                hintElement = document.createElement('div');
                hintElement.id = 'promoCodeHint';
                hintElement.style.cssText = `
                    font-size: 0.9rem;
                    margin-top: 8px;
                    padding: 8px 12px;
                    border-radius: 8px;
                    transition: all 0.3s ease;
                `;
                
                const promoContainer = document.querySelector('.promo-input-container');
                promoContainer.parentNode.appendChild(hintElement);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
            const isValidFormat = /^MUS-[A-Z]{2}\d{4}$/.test(value);
            const isPartialFormat = /^MUS(-[A-Z]{0,2}\d{0,4})?$/.test(value);
            
            if (value === '') {
                hintElement.style.display = 'none';
            } else if (isValidFormat) {
                hintElement.innerHTML = '‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞';
                hintElement.style.backgroundColor = '#f0fff4';
                hintElement.style.color = '#38a169';
                hintElement.style.border = '1px solid #9ae6b4';
                hintElement.style.display = 'block';
            } else if (isPartialFormat && value.length < 10) {
                hintElement.innerHTML = 'üí° –§–æ—Ä–º–∞—Ç: MUS-XX0000 (–Ω–∞–ø—Ä–∏–º–µ—Ä, MUS-RL6036)';
                hintElement.style.backgroundColor = '#fffbf0';
                hintElement.style.color = '#d69e2e';
                hintElement.style.border = '1px solid #fbd38d';
                hintElement.style.display = 'block';
            } else {
                hintElement.innerHTML = '‚ö†Ô∏è –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –û–∂–∏–¥–∞–µ—Ç—Å—è: MUS-XX0000';
                hintElement.style.backgroundColor = '#fff5f5';
                hintElement.style.color = '#e53e3e';
                hintElement.style.border = '1px solid #feb2b2';
                hintElement.style.display = 'block';
            }
        }

        function goToStep(step) {
            document.querySelector('.step.active').classList.remove('active');
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            updateProgress();
            smoothScrollToTop();
        }

        function updateProgress() {
            const progress = (currentStep / 4) * 100;
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }

        function smoothScrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function testGoogleSheetsConnection() {
            try {
                console.log('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets...');
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–ª—è Telegram
                const isInTelegram = window.Telegram && window.Telegram.WebApp;
                if (isInTelegram) {
                    console.log('üì± –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Telegram WebApp');
                }
                
                const startTime = performance.now();
                await makeAPIRequest('get', { sheetName: 'PromoCodes', range: 'A1:A1' });
                const endTime = performance.now();
                
                const responseTime = Math.round(endTime - startTime);
                console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Google Sheets —É—Å–ø–µ—à–Ω–æ (${responseTime}ms)`);
                
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                updateConnectionStatus(true);
                
                // –í Telegram –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª–∏
                if (isInTelegram) {
                    console.log(`‚ö° –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${responseTime < 1000 ? '–ë—ã—Å—Ç—Ä–∞—è' : responseTime < 3000 ? '–°—Ä–µ–¥–Ω—è—è' : '–ú–µ–¥–ª–µ–Ω–Ω–∞—è'}`);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                updateConnectionStatus(false);
                
                // –°–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –≤ –∫–æ–Ω—Å–æ–ª—å
                const isInTelegram = window.Telegram && window.Telegram.WebApp;
                if (isInTelegram) {
                    console.group('üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Telegram WebApp:');
                    console.log('üì± –í–µ—Ä—Å–∏—è:', window.Telegram.WebApp.version);
                    console.log('üåç –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:', window.Telegram.WebApp.platform);
                    console.log('üé® –¢–µ–º–∞:', window.Telegram.WebApp.colorScheme);
                    console.groupEnd();
                }
            }
        }

        async function submitPromoCode() {
            const promoCode = document.getElementById('promoCode').value.trim();
            const submitBtn = document.getElementById('promoSubmitBtn');
            
            if (!promoCode) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
            const promoCodePattern = /^MUS-[A-Z]{2}\d{4}$/;
            if (!promoCodePattern.test(promoCode)) {
                showNotification('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è: MUS-XX0000', 'error');
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—à–∏–±–∫–∏
                const promoInput = document.getElementById('promoCode');
                promoInput.style.borderColor = '#f56565';
                promoInput.style.animation = 'shake 0.5s ease-in-out';
                
                setTimeout(() => {
                    promoInput.style.borderColor = '#e2e8f0';
                    promoInput.style.animation = '';
                }, 2000);
                
                return;
            }

            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span>–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –±–∞–∑–µ...';
            submitBtn.disabled = true;

            try {
                console.log('üéüÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥:', promoCode);
                
                const validation = await validatePromoCode(promoCode);
                console.log('üìù –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', validation);

                if (validation.valid) {
                    orderData.promoCode = promoCode;
                    orderData.promoValidation = validation;
                    showNotification('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–∞–π–¥–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                    const hintElement = document.getElementById('promoCodeHint');
                    if (hintElement) {
                        hintElement.style.display = 'none';
                    }
                    
                    goToStep(2);
                } else {
                    showNotification(`‚ùå ${validation.message}`, 'error');
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                    const promoInput = document.getElementById('promoCode');
                    promoInput.style.borderColor = '#f56565';
                    promoInput.style.animation = 'shake 0.5s ease-in-out';
                    
                    setTimeout(() => {
                        promoInput.style.borderColor = '#e2e8f0';
                        promoInput.style.animation = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', error);
                
                let errorMsg = 'üîå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                if (error.message.includes('404')) {
                    errorMsg = '‚öôÔ∏è –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                } else if (error.message.includes('500')) {
                    errorMsg = 'üîß –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞';
                }
                
                showNotification(errorMsg, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function submitSongRequest() {
            const recipient = document.getElementById('songRecipient').value.trim();
            const genre = document.getElementById('songGenre').value.trim();
            const theme = document.getElementById('songTheme').value.trim();
            const wishes = document.getElementById('songWishes').value.trim();

            if (!recipient || !genre || !theme) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            orderData.recipient = recipient;
            orderData.genre = genre;
            orderData.theme = theme;
            orderData.wishes = wishes;

            showOrderSummary();
            goToStep(3);
        }

        function showOrderSummary() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –≤ –ø—Ä–µ–≤—å—é (–µ—Å–ª–∏ —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω)
            if (currentOrderId) {
                document.getElementById('orderNumberPreview').textContent = '#' + currentOrderId;
            }
            
            document.getElementById('summaryPromo').textContent = orderData.promoCode;
            document.getElementById('summaryRecipient').textContent = orderData.recipient;
            document.getElementById('summaryGenre').textContent = orderData.genre;
            document.getElementById('summaryTheme').textContent = 
                orderData.theme.length > 100 ? 
                orderData.theme.substring(0, 100) + '...' : 
                orderData.theme;
        }

        async function confirmOrder() {
            try {
                const confirmBtn = event.target;
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<span class="loading"></span>–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑...';
                confirmBtn.disabled = true;

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –∑–∞–∫–∞–∑–∞
                currentOrderId = 'ORD' + Date.now().toString().slice(-6);
                console.log('üÜî ID –∑–∞–∫–∞–∑–∞:', currentOrderId);
                
                // –ö–†–ò–¢–ò–ß–ù–û: –°—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
                const orderNumberElement = document.getElementById('orderNumber');
                console.log('üîç –≠–ª–µ–º–µ–Ω—Ç orderNumber –Ω–∞–π–¥–µ–Ω:', !!orderNumberElement);
                console.log('üîç –¢–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç–ª–µ–º–µ–Ω—Ç–∞:', orderNumberElement ? orderNumberElement.textContent : '–≠–õ–ï–ú–ï–ù–¢ –ù–ï –ù–ê–ô–î–ï–ù');
                
                // –°–†–ê–ó–£ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                if (orderNumberElement) {
                    orderNumberElement.textContent = '#' + currentOrderId;
                    console.log('üéØ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:', currentOrderId);
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:', orderNumberElement.textContent);
                } else {
                    console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –≠–ª–µ–º–µ–Ω—Ç orderNumber –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ–º –ª–∏ –º—ã –≤ Telegram
                const isInTelegram = window.Telegram && window.Telegram.WebApp;
                console.log(`üîß –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: ${isInTelegram ? 'Telegram WebApp' : '–û–±—ã—á–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä'}`);

                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userContact = getUserContact();
                
                // –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º –≤–≤–æ–¥–∞
                if (userContact === 'pending') {
                    orderCreationPending = true;
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    return;
                }
                
                const userName = orderData.recipient || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';

                console.log('üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', { userContact, userName });

                // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ —Å retry –ª–æ–≥–∏–∫–æ–π –¥–ª—è Telegram
                let attempts = isInTelegram ? 3 : 1;
                let lastError = null;
                
                for (let attempt = 1; attempt <= attempts; attempt++) {
                    try {
                        console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}${isInTelegram ? ' (Telegram —Ä–µ–∂–∏–º)' : ''}`);
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        confirmBtn.innerHTML = '<span class="loading"></span>–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...';
                        const userResult = await saveUser({ name: userName, contact: userContact, source: isInTelegram ? 'telegram' : 'web' });
                        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', userResult);

                        // –û—Ç–º–µ—á–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
                        confirmBtn.innerHTML = '<span class="loading"></span>–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø—Ä–æ–º–æ–∫–æ–¥...';
                        console.log('üéüÔ∏è –ù–∞—á–∏–Ω–∞–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞...');
                        
                        const promoResult = await markPromoCodeAsUsed(orderData.promoCode, { name: userName, contact: userContact });
                        console.log('üéüÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', promoResult);
                        
                        if (!promoResult.success) {
                            console.warn('‚ö†Ô∏è –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω:', promoResult.message);
                            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                        } else {
                            console.log('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
                        }

                        // –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑
                        confirmBtn.innerHTML = '<span class="loading"></span>–°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –≤ —Å–∏—Å—Ç–µ–º–µ...';
                        const orderInfo = [
                            currentOrderId,
                            userResult.userId || 1,
                            userContact,
                            userName,
                            orderData.promoCode,
                            orderData.recipient,
                            orderData.genre,
                            orderData.theme,
                            orderData.wishes,
                            'pending',
                            new Date().toISOString(),
                            '', // completedAt
                            '', // fileId  
                            ''  // comment
                        ];

                        const orderResult = await appendToSheet('Orders', orderInfo);
                        console.log('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω:', orderResult);

                        if (orderResult) {
                            document.getElementById('orderNumber').textContent = '#' + currentOrderId;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∫–∞–∫ backup
                            const localOrders = JSON.parse(localStorage.getItem('userOrders') || '[]');
                            localOrders.push({ 
                                ...orderData, 
                                orderId: currentOrderId, 
                                status: 'pending', 
                                createdAt: new Date().toISOString(),
                                source: isInTelegram ? 'telegram' : 'web'
                            });
                            localStorage.setItem('userOrders', JSON.stringify(localOrders));
                            
                            clearFormDraft();
                            
                            // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ —É—Å–ø–µ—Ö–µ
                            showNotification('üéâ –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
                            
                            // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram –±–æ—Ç–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
                            if (isInTelegram) {
                                console.log('üì± –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram –±–æ—Ç–∞...');
                                console.log('üîç telegramApp –¥–æ—Å—Ç—É–ø–µ–Ω:', !!telegramApp);
                                console.log('üîç telegramApp.sendData –¥–æ—Å—Ç—É–ø–µ–Ω:', !!(telegramApp && telegramApp.sendData));
                                
                                if (telegramApp && telegramApp.sendData) {
                                    try {
                                        const botMessage = `üéµ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑!
üìã ${currentOrderId}
üë§ ${userName}
üì± ${userContact}
üéüÔ∏è ${orderData.promoCode}
üé≠ ${orderData.recipient} - ${orderData.genre}`;

                                        const simpleData = {
                                            action: 'new_order',
                                            orderId: currentOrderId,
                                            message: botMessage
                                        };
                                        
                                        console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', simpleData);
                                        telegramApp.sendData(JSON.stringify(simpleData));
                                        console.log('‚úÖ sendData –≤—ã–∑–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
                                        
                                        showBrowserNotification('üì§ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç–∞', 'success');
                                        
                                    } catch (error) {
                                        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ sendData:', error);
                                        showBrowserNotification('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –±–æ—Ç–∞: ' + error.message, 'error');
                                    }
                                } else {
                                    console.warn('‚ö†Ô∏è Telegram sendData –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
                                    console.log('üîç telegramApp:', telegramApp);
                                    
                                    if (telegramApp) {
                                        console.log('üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã telegramApp:', Object.keys(telegramApp));
                                    }
                                }
                            } else {
                                console.log('üåê –ù–µ –≤ Telegram, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –≤ –±–æ—Ç–∞');
                            }
                            
                            goToStep(4);
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è fallback
                    setTimeout(() => {
                        const orderNumberElement = document.getElementById('orderNumber');
                        const currentDisplayed = orderNumberElement.textContent;
                        console.log('üîç Fallback –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞:', currentDisplayed);
                        
                        if (currentDisplayed === '#–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...' || !currentDisplayed.includes(currentOrderId)) {
                            console.log('‚ö†Ô∏è Fallback: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...');
                            orderNumberElement.textContent = '#' + currentOrderId;
                            console.log('‚úÖ Fallback: –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', currentOrderId);
                        }
                    }, 500);
                            
                            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —à–∞–≥—É 4
                            setTimeout(() => {
                                const orderNumberElement = document.getElementById('orderNumber');
                                const currentDisplayed = orderNumberElement.textContent;
                                console.log('üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞:', currentDisplayed);
                                
                                if (currentDisplayed === '#–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...' || !currentDisplayed.includes(currentOrderId)) {
                                    console.log('‚ö†Ô∏è –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...');
                                    orderNumberElement.textContent = '#' + currentOrderId;
                                    console.log('‚úÖ –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', currentOrderId);
                                }
                            }, 500);
                            
                            return; // –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏
                        } else {
                            throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                        }
                        
                    } catch (attemptError) {
                        lastError = attemptError;
                        console.warn(`‚ùå –ü–æ–ø—ã—Ç–∫–∞ ${attempt} –Ω–µ—É–¥–∞—á–Ω–∞:`, attemptError.message);
                        
                        if (attempt < attempts) {
                            // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
                            confirmBtn.innerHTML = `<span class="loading"></span>–ü–æ–≤—Ç–æ—Ä... (${attempt + 1}/${attempts})`;
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                }
                
                // –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã
                throw lastError;

            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
                
                let errorMessage = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞';
                let shouldSaveLocally = false;
                
                if (error.message.includes('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è')) {
                    errorMessage = '‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –ª–æ–∫–∞–ª—å–Ω–æ.';
                    shouldSaveLocally = true;
                } else if (error.message.includes('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏')) {
                    errorMessage = 'üåê –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é. –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ.';
                    shouldSaveLocally = true;
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'üîå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ.';
                    shouldSaveLocally = true;
                }
                
                if (shouldSaveLocally) {
                    // Fallback –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—é
                    const fallbackOrder = {
                        orderId: currentOrderId,
                        ...orderData,
                        userContact: getUserContact(),
                        status: 'pending_sync',
                        createdAt: new Date().toISOString(),
                        source: window.Telegram && window.Telegram.WebApp ? 'telegram' : 'web'
                    };
                    
                    const localOrders = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
                    localOrders.push(fallbackOrder);
                    localStorage.setItem('pendingOrders', JSON.stringify(localOrders));
                    
                    // –ö–†–ò–¢–ò–ß–ù–û: –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
                    console.log('üíæ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ –¥–ª—è fallback:', currentOrderId);
                    document.getElementById('orderNumber').textContent = '#' + currentOrderId;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–æ–º–µ—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                    const displayedNumber = document.getElementById('orderNumber').textContent;
                    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –Ω–æ–º–µ—Ä–∞:', displayedNumber);
                    
                    showNotification('üíæ –ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω. –ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏.', 'success');
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –±–æ—Ç–∞ –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
                    if (window.Telegram && window.Telegram.WebApp) {
                        try {
                            const orderMessageOffline = `üì± –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω –æ—Ñ–ª–∞–π–Ω

üìã –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: ${currentOrderId}
üë§ –ó–∞–∫–∞–∑—á–∏–∫: ${orderData.recipient || '–ù–µ —É–∫–∞–∑–∞–Ω'}
üéüÔ∏è –ü—Ä–æ–º–æ–∫–æ–¥: ${orderData.promoCode}
üîÑ –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

‚ö†Ô∏è –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è`;

                            window.Telegram.WebApp.sendData(JSON.stringify({
                                action: 'offline_order',
                                orderId: currentOrderId,
                                message: orderMessageOffline,
                                orderData: fallbackOrder
                            }));
                            
                            console.log('üì§ –û—Ñ–ª–∞–π–Ω –∑–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –±–æ—Ç–∞');
                        } catch (e) {
                            console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ñ–ª–∞–π–Ω –∑–∞–∫–∞–∑ –≤ –±–æ—Ç–∞:', e);
                        }
                    }
                    
                    goToStep(4);
                    
                } else {
                    errorMessage = `‚ùå ${error.message}`;
                    showNotification(errorMessage, 'error');
                }
                
            } finally {
                if (event.target) {
                    event.target.innerHTML = '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑';
                    event.target.disabled = false;
                }
            }
        }

        function getUserContact() {
            // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram
            const tgUser = localStorage.getItem('tg_user');
            if (tgUser) {
                const user = JSON.parse(tgUser);
                const contact = user.username ? `@${user.username}` : `tg_${user.id}`;
                localStorage.setItem('userContact', contact);
                console.log('üë§ –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram –∫–æ–Ω—Ç–∞–∫—Ç:', contact);
                return contact;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç
            let contact = localStorage.getItem('userContact');
            if (contact) {
                console.log('üë§ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç:', contact);
                return contact;
            }
            
            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
            showContactInputModal();
            return 'pending'; // –í—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        }

        function showContactInputModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">üì± –ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏</h3>
                    </div>
                    <div style="padding: 30px;">
                        <p style="margin-bottom: 25px; color: #718096; line-height: 1.6;">
                            –î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –Ω–∞–º –Ω—É–∂–µ–Ω —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ —Å –≤–∞–º–∏, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–æ—Ç–æ–≤—É—é –ø–µ—Å–Ω—é:
                        </p>
                        
                        <div class="form-group">
                            <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±:</label>
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                                    <input type="radio" name="contactType" value="telegram" style="margin-right: 12px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #4a5568;">üì± Telegram</div>
                                        <div style="font-size: 0.9rem; color: #718096;">–£–∫–∞–∂–∏—Ç–µ –≤–∞—à @username</div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                                    <input type="radio" name="contactType" value="email" style="margin-right: 12px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #4a5568;">üìß Email</div>
                                        <div style="font-size: 0.9rem; color: #718096;">–í–∞—à–∞ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</div>
                                    </div>
                                </label>
                                
                                <label style="display: flex; align-items: center; padding: 15px; border: 2px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: all 0.3s ease;">
                                    <input type="radio" name="contactType" value="phone" style="margin-right: 12px; transform: scale(1.2);">
                                    <div>
                                        <div style="font-weight: 600; color: #4a5568;">üìû –¢–µ–ª–µ—Ñ–æ–Ω</div>
                                        <div style="font-size: 0.9rem; color: #718096;">–ù–æ–º–µ—Ä –¥–ª—è WhatsApp –∏–ª–∏ –∑–≤–æ–Ω–∫–æ–≤</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group" id="contactInputGroup" style="display: none;">
                            <label class="form-label" id="contactInputLabel">–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç:</label>
                            <input type="text" class="form-input" id="contactInput" placeholder="">
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-primary" id="saveContactBtn" disabled>
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫
            const radioButtons = modal.querySelectorAll('input[name="contactType"]');
            const inputGroup = document.getElementById('contactInputGroup');
            const inputLabel = document.getElementById('contactInputLabel');
            const contactInput = document.getElementById('contactInput');
            const saveBtn = document.getElementById('saveContactBtn');
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–ø—Ü–∏–∏
                    radioButtons.forEach(r => {
                        r.closest('label').style.borderColor = '#e2e8f0';
                        r.closest('label').style.backgroundColor = 'transparent';
                    });
                    
                    this.closest('label').style.borderColor = '#667eea';
                    this.closest('label').style.backgroundColor = 'rgba(102, 126, 234, 0.05)';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    inputGroup.style.display = 'block';
                    
                    if (this.value === 'telegram') {
                        inputLabel.textContent = 'üì± Telegram username:';
                        contactInput.placeholder = '@username';
                        contactInput.value = '';
                    } else if (this.value === 'email') {
                        inputLabel.textContent = 'üìß Email –∞–¥—Ä–µ—Å:';
                        contactInput.placeholder = 'example@email.com';
                        contactInput.value = '';
                    } else if (this.value === 'phone') {
                        inputLabel.textContent = 'üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:';
                        contactInput.placeholder = '+7 900 123-45-67';
                        contactInput.value = '';
                    }
                    
                    contactInput.focus();
                    checkSaveButton();
                });
            });
            
            contactInput.addEventListener('input', checkSaveButton);
            
            function checkSaveButton() {
                const selectedType = modal.querySelector('input[name="contactType"]:checked');
                const inputValue = contactInput.value.trim();
                saveBtn.disabled = !selectedType || !inputValue;
            }
            
            saveBtn.addEventListener('click', function() {
                const selectedType = modal.querySelector('input[name="contactType"]:checked');
                const inputValue = contactInput.value.trim();
                
                if (!selectedType || !inputValue) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç', 'error');
                    return;
                }
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                let isValid = false;
                let formattedContact = inputValue;
                
                if (selectedType.value === 'telegram') {
                    if (inputValue.startsWith('@') && inputValue.length > 1) {
                        isValid = true;
                    } else if (!inputValue.startsWith('@') && inputValue.length > 0) {
                        formattedContact = '@' + inputValue;
                        isValid = true;
                    }
                } else if (selectedType.value === 'email') {
                    isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(inputValue);
                } else if (selectedType.value === 'phone') {
                    isValid = /^[\+]?[0-9\s\-\(\)]{10,}$/.test(inputValue);
                }
                
                if (!isValid) {
                    let errorMsg = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç';
                    if (selectedType.value === 'telegram') errorMsg = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π @username';
                    else if (selectedType.value === 'email') errorMsg = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
                    else if (selectedType.value === 'phone') errorMsg = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
                    
                    showNotification(errorMsg, 'error');
                    return;
                }
                
                localStorage.setItem('userContact', formattedContact);
                localStorage.setItem('contactType', selectedType.value);
                modal.remove();
                
                console.log('üë§ –ö–æ–Ω—Ç–∞–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', formattedContact);
                
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
                continueOrderCreation();
            });
        }

        let orderCreationPending = false;

        function continueOrderCreation() {
            if (orderCreationPending) {
                // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
                confirmOrder();
            }
        }

        async function saveUser(userInfo) {
            try {
                console.log('üë§ –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userInfo);
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                const existingUser = await findRowByValue('Users', userInfo.contact);
                console.log('üîç –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', existingUser);
                
                if (existingUser) {
                    console.log('üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥');
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞ (—Å—Ç–æ–ª–±–µ—Ü D)
                    const timestamp = new Date().toISOString();
                    await updateCell('Users', `D${existingUser.rowIndex}`, timestamp);
                    return { userId: existingUser.rowIndex, isNew: false };
                } else {
                    console.log('‚ûï –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const userData = [
                        userInfo.contact || '',           // A: –ö–æ–Ω—Ç–∞–∫—Ç
                        userInfo.name || '',             // B: –ò–º—è
                        new Date().toISOString(),        // C: –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        new Date().toISOString(),        // D: –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥
                        userInfo.source || 'web'         // E: –ò—Å—Ç–æ—á–Ω–∏–∫
                    ];

                    console.log('üì§ –î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', userData);
                    const result = await appendToSheet('Users', userData);
                    console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', result);
                    
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID
                    const allUsers = await makeAPIRequest('get', { sheetName: 'Users' });
                    const userId = allUsers.values ? allUsers.values.length : 1;
                    
                    console.log('üÜî –ü—Ä–∏—Å–≤–æ–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
                    return { userId: userId, isNew: true };
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–ª–±—ç–∫ ID —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
                return { userId: Date.now(), isNew: true };
            }
        }

        async function markPromoCodeAsUsed(promoCode, userInfo) {
            try {
                console.log('üéüÔ∏è –û—Ç–º–µ—á–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π:', promoCode);
                
                const validation = orderData.promoValidation;
                if (!validation || !validation.valid) {
                    throw new Error('–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –≤–∞–ª–∏–¥–µ–Ω –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }

                console.log('üìä –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:', validation);
                console.log('üìç –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É:', validation.rowIndex);

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π (—Å—Ç–æ–ª–±–µ—Ü D)
                const newUseCount = validation.currentUses + 1;
                console.log(`üî¢ –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: ${validation.currentUses} ‚Üí ${newUseCount}`);
                
                const updateUsesResult = await updateCell('PromoCodes', `D${validation.rowIndex}`, newUseCount);
                console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:', updateUsesResult);

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Å—Ç–æ–ª–±–µ—Ü F)
                const timestamp = new Date().toISOString();
                console.log('üìÖ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞—Ç—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:', timestamp);
                
                const updateDateResult = await updateCell('PromoCodes', `F${validation.rowIndex}`, timestamp);
                console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—Ç—ã:', updateDateResult);

                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (—Å—Ç–æ–ª–±–µ—Ü G)
                const userDescription = `${userInfo.name || '–ê–Ω–æ–Ω–∏–º'} (${userInfo.contact || '–ù–µ —É–∫–∞–∑–∞–Ω'})`;
                console.log('üë§ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userDescription);
                
                const updateUserResult = await updateCell('PromoCodes', `G${validation.rowIndex}`, userDescription);
                console.log('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', updateUserResult);

                console.log('üéâ –ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π');
                return { success: true, message: '–ü—Ä–æ–º–æ–∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' };
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞:', error);
                return { success: false, message: '–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞: ' + error.message };
            }
        }

        function createNewOrder() {
            orderData = {};
            currentOrderId = null;
            currentStep = 1;
            
            document.getElementById('promoForm').reset();
            document.getElementById('songRequestForm').reset();
            
            goToStep(1);
            showNotification('–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É –∑–∞–∫–∞–∑—É!', 'success');
        }

        async function checkOrderStatus() {
            const orderId = document.getElementById('orderCheckId').value.trim();
            
            if (!orderId) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞', 'error');
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞
            const orderIdPattern = /^ORD\d{6}$/;
            if (!orderIdPattern.test(orderId)) {
                showNotification('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∑–∞–∫–∞–∑–∞. –û–∂–∏–¥–∞–µ—Ç—Å—è: ORD000000', 'error');
                
                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—à–∏–±–∫–∏
                const orderInput = document.getElementById('orderCheckId');
                orderInput.style.borderColor = '#f56565';
                orderInput.style.animation = 'shake 0.5s ease-in-out';
                
                setTimeout(() => {
                    orderInput.style.borderColor = '#e2e8f0';
                    orderInput.style.animation = '';
                }, 2000);
                
                return;
            }

            const originalBtn = event.target;
            const originalText = originalBtn.innerHTML;
            originalBtn.innerHTML = '<span class="loading"></span>–ü—Ä–æ–≤–µ—Ä—è–µ–º...';
            originalBtn.disabled = true;

            try {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:', orderId);
                
                // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ Google Sheets
                let order = null;
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã –∏–∑ Google Sheets
                    const ordersData = await makeAPIRequest('get', { sheetName: 'Orders' });
                    const orders = ordersData.values || [];
                    
                    console.log('üìã –ü–æ–ª—É—á–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Google Sheets:', orders.length);
                    
                    // –ò—â–µ–º –∑–∞–∫–∞–∑ –ø–æ ID (–ø–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü)
                    const foundOrderRow = orders.find(row => row[0] === orderId);
                    
                    if (foundOrderRow) {
                        order = {
                            orderId: foundOrderRow[0],
                            userId: foundOrderRow[1],
                            userContact: foundOrderRow[2],
                            userName: foundOrderRow[3],
                            promoCode: foundOrderRow[4],
                            recipient: foundOrderRow[5],
                            genre: foundOrderRow[6],
                            theme: foundOrderRow[7],
                            wishes: foundOrderRow[8],
                            status: foundOrderRow[9] || 'pending',
                            createdAt: foundOrderRow[10],
                            completedAt: foundOrderRow[11],
                            fileId: foundOrderRow[12],
                            comment: foundOrderRow[13],
                            source: 'sheets'
                        };
                        console.log('‚úÖ –ó–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω –≤ Google Sheets:', order);
                    }
                } catch (sheetsError) {
                    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets:', sheetsError);
                }
                
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Sheets, –∏—â–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏–∏
                if (!order) {
                    console.log('üîç –ò—â–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ...');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ userOrders
                    const userOrders = JSON.parse(localStorage.getItem('userOrders') || '[]');
                    let localOrder = userOrders.find(o => o.orderId === orderId);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ pendingOrders
                    if (!localOrder) {
                        const pendingOrders = JSON.parse(localStorage.getItem('pendingOrders') || '[]');
                        localOrder = pendingOrders.find(o => o.orderId === orderId);
                    }
                    
                    if (localOrder) {
                        order = { ...localOrder, source: 'local' };
                        console.log('‚úÖ –ó–∞–∫–∞–∑ –Ω–∞–π–¥–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:', order);
                    }
                }

                if (order) {
                    console.log('üìä –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–∫–∞–∑–µ');
                    showOrderStatusModal(order);
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                    const hintElement = document.getElementById('orderIdHint');
                    if (hintElement) {
                        hintElement.style.display = 'none';
                    }
                } else {
                    console.log('‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏–≥–¥–µ');
                    showNotification('‚ùå –ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞.', 'error');
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    setTimeout(() => {
                        showBrowserNotification('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞ —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ORD123456', 'info');
                    }, 2000);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
                showNotification('üîå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'error');
            } finally {
                originalBtn.innerHTML = originalText;
                originalBtn.disabled = false;
            }
        }

        function showOrderStatusModal(order) {
            console.log('üìã –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞–∫–∞–∑–∞:', order.orderId);
            
            const statusInfo = {
                'pending': { 
                    text: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ', 
                    color: '#d69e2e', 
                    icon: '‚è≥',
                    description: '–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏'
                },
                'in_progress': { 
                    text: '–°–æ–∑–¥–∞–µ—Ç—Å—è', 
                    color: '#3182ce', 
                    icon: 'üéµ',
                    description: '–ö–æ–º–ø–æ–∑–∏—Ç–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥ –ø–µ—Å–Ω–µ–π'
                },
                'completed': { 
                    text: '–ì–æ—Ç–æ–≤', 
                    color: '#38a169', 
                    icon: '‚úÖ',
                    description: '–ü–µ—Å–Ω—è –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è'
                },
                'delivered': { 
                    text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', 
                    color: '#38a169', 
                    icon: 'üì±',
                    description: '–ü–µ—Å–Ω—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é'
                },
                'pending_sync': {
                    text: '–û–∂–∏–¥–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏',
                    color: '#805ad5',
                    icon: 'üîÑ',
                    description: '–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ'
                }
            };

            const status = statusInfo[order.status] || statusInfo['pending'];
            const isFromSheets = order.source === 'sheets';

            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            modalContent.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">${status.icon} –ó–∞–∫–∞–∑ #${order.orderId}</h3>
                    <button class="close-btn" id="closeModalBtn">&times;</button>
                </div>
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">${status.icon}</div>
                        <h3 style="color: ${status.color}; margin-bottom: 8px; font-size: 1.3rem;">${status.text}</h3>
                        <p style="color: #718096; font-size: 0.95rem; margin: 0;">${status.description}</p>
                    </div>
                    
                    <div style="background: #f7fafc; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                        <div style="display: grid; gap: 8px; font-size: 0.9rem;">
                            <div><strong>–î–∞—Ç–∞:</strong> ${order.createdAt ? new Date(order.createdAt).toLocaleDateString('ru') : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                            ${order.recipient ? `<div><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${order.recipient}</div>` : ''}
                            ${order.genre ? `<div><strong>–ñ–∞–Ω—Ä:</strong> ${order.genre}</div>` : ''}
                            ${order.promoCode ? `<div><strong>–ü—Ä–æ–º–æ–∫–æ–¥:</strong> ${order.promoCode}</div>` : ''}
                            ${order.theme ? `<div><strong>–¢–µ–º–∞:</strong> ${order.theme.length > 80 ? order.theme.substring(0, 80) + '...' : order.theme}</div>` : ''}
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                                <strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong> <span style="color: ${isFromSheets ? '#38a169' : '#d69e2e'};">${isFromSheets ? 'üåê –°–µ—Ä–≤–µ—Ä' : 'üíæ –õ–æ–∫–∞–ª—å–Ω–æ'}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${order.status === 'pending' || order.status === 'pending_sync' ? `
                        <div style="text-align: center; padding: 12px; background: #f0f4ff; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem;">
                            <strong>üìÖ –°—Ä–æ–∫–∏:</strong> 2-5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary" id="refreshOrderBtn" style="font-size: 0.9rem; padding: 10px 15px;">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        ${order.status === 'completed' ? `
                            <button class="btn btn-success" id="downloadOrderBtn" style="font-size: 0.9rem; padding: 10px 15px;">
                                üéµ –ü–æ–ª—É—á–∏—Ç—å
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            console.log('üìã –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–æ, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏...');

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è
            const closeBtn = document.getElementById('closeModalBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    console.log('‚ùå –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞');
                    modal.remove();
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            const refreshBtn = document.getElementById('refreshOrderBtn');
            if (refreshBtn) {
                console.log('üîÑ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                refreshBtn.addEventListener('click', async () => {
                    console.log('üîÑ –ù–ê–ñ–ê–¢–ê –∫–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è:', order.orderId);
                    
                    const originalText = refreshBtn.innerHTML;
                    refreshBtn.innerHTML = '<span class="loading"></span>–û–±–Ω–æ–≤–ª—è–µ–º...';
                    refreshBtn.disabled = true;
                    
                    try {
                        await refreshOrderStatus(order.orderId);
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                    } finally {
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                        setTimeout(() => {
                            refreshBtn.innerHTML = originalText;
                            refreshBtn.disabled = false;
                        }, 1000);
                    }
                });
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const downloadBtn = document.getElementById('downloadOrderBtn');
            if (downloadBtn) {
                console.log('üéµ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
                downloadBtn.addEventListener('click', () => {
                    console.log('üéµ –ù–ê–ñ–ê–¢–ê –∫–Ω–æ–ø–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Å–Ω–∏ –¥–ª—è:', order.orderId);
                    
                    const originalText = downloadBtn.innerHTML;
                    downloadBtn.innerHTML = '<span class="loading"></span>–ì–æ—Ç–æ–≤–∏–º...';
                    downloadBtn.disabled = true;
                    
                    simulateDownload(order.orderId);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                    setTimeout(() => {
                        downloadBtn.innerHTML = originalText;
                        downloadBtn.disabled = false;
                    }, 2000);
                });
            }
            
            console.log('‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
        }

        function restoreFormData() {
            const savedData = JSON.parse(localStorage.getItem('formDataDraft') || '{}');
            if (Object.keys(savedData).length > 0) {
                document.getElementById('promoCode').value = savedData.promoCode || '';
                document.getElementById('songRecipient').value = savedData.recipient || '';
                document.getElementById('songGenre').value = savedData.genre || '';
                document.getElementById('songTheme').value = savedData.theme || '';
                document.getElementById('songWishes').value = savedData.wishes || '';
                
                if (savedData.currentStep) {
                    goToStep(savedData.currentStep);
                }
                
                // –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                console.log('üíæ –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —á–µ—Ä–Ω–æ–≤–∏–∫–∞');
            }
        }

        function saveFormDraft() {
            const formData = {
                promoCode: document.getElementById('promoCode').value,
                recipient: document.getElementById('songRecipient').value,
                genre: document.getElementById('songGenre').value,
                theme: document.getElementById('songTheme').value,
                wishes: document.getElementById('songWishes').value,
                currentStep: currentStep
            };
            localStorage.setItem('formDataDraft', JSON.stringify(formData));
        }

        function clearFormDraft() {
            localStorage.removeItem('formDataDraft');
        }

        function setupFloatingNotes() {
            const notesContainer = document.getElementById('floatingNotes');
            const notes = ['‚ô™', '‚ô´', '‚ô¨', '‚ô©', '‚ô≠', '‚ôØ', 'ùÑû'];
            
            function createNote() {
                const note = document.createElement('div');
                note.className = 'note';
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                note.style.left = Math.random() * 100 + '%';
                note.style.animationDuration = (Math.random() * 10 + 10) + 's';
                note.style.animationDelay = Math.random() * 5 + 's';
                
                notesContainer.appendChild(note);
                
                setTimeout(() => {
                    note.remove();
                }, 20000);
            }
            
            setInterval(createNote, 3000);
            for (let i = 0; i < 5; i++) {
                setTimeout(createNote, i * 1000);
            }
        }

        function addConnectionStatus() {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'connectionStatus';
            statusDiv.className = 'connection-status online';
            statusDiv.innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ';
            document.body.appendChild(statusDiv);
        }

        function updateConnectionStatus(isOnline) {
            const statusDiv = document.getElementById('connectionStatus');
            if (statusDiv) {
                statusDiv.className = `connection-status ${isOnline ? 'online' : 'offline'}`;
                statusDiv.innerHTML = isOnline ? 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ' : 'üî¥ –ù–µ—Ç —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π';
            }
        }

        function addTooltips() {
            addTooltip('promoCode', '–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä, –æ–±—ã—á–Ω–æ 4-20 —Å–∏–º–≤–æ–ª–æ–≤');
            addTooltip('songGenre', '–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–ø, —Ä–æ–∫, —Ä—ç–ø, –±–∞–ª–ª–∞–¥–∞, –¥–∂–∞–∑, –∫–ª–∞—Å—Å–∏–∫–∞');
        }

        function addTooltip(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.title = text;
                element.style.cursor = 'help';
            }
        }

        function addSettingsButton() {
            const settingsBtn = document.createElement('button');
            settingsBtn.textContent = '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
            settingsBtn.className = 'btn btn-secondary';
            settingsBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; z-index: 1000; padding: 10px;';
            settingsBtn.onclick = showSettingsModal;
            document.body.appendChild(settingsBtn);
        }

        function showSettingsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 20px;">
                        <div class="form-group">
                            <label class="form-label">–í–∞—à –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏:</label>
                            <input type="text" class="form-input" id="settingsContact" 
                                value="${localStorage.getItem('userContact') || ''}"
                                placeholder="Telegram, Email –∏–ª–∏ –¢–µ–ª–µ—Ñ–æ–Ω"
                            >
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function saveSettings() {
            const contactInput = document.getElementById('settingsContact');
            const contact = contactInput.value.trim();
            localStorage.setItem('userContact', contact);
            document.querySelector('.modal').remove();
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', 'success');
        }

        // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
        document.addEventListener('input', saveFormDraft);
        window.addEventListener('beforeunload', saveFormDraft);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è—á–µ–µ–∫ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        async function testCellUpdate() {
            console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —è—á–µ–µ–∫...');
            
            try {
                // –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è—á–µ–π–∫–∏
                const testResult = await updateCell('PromoCodes', 'H1', 'test_' + Date.now());
                console.log('‚úÖ –¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —è—á–µ–π–∫–∏ —É—Å–ø–µ—à–µ–Ω:', testResult);
                
                // –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ Users
                const testUser = ['test_contact_' + Date.now(), 'Test User', new Date().toISOString(), new Date().toISOString(), 'test'];
                const appendResult = await appendToSheet('Users', testUser);
                console.log('‚úÖ –¢–µ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–µ–Ω:', appendResult);
                
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                return false;
            }
        }

        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.testCellUpdate = testCellUpdate;
        window.debugUser = async (contact) => {
            console.log('üîç –û—Ç–ª–∞–¥–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è:', contact);
            const result = await saveUser({ contact, name: 'Test User', source: 'debug' });
            console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç:', result);
            return result;
        };
        window.debugPromo = async (promoCode) => {
            console.log('üîç –û—Ç–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞:', promoCode);
            const validation = await validatePromoCode(promoCode);
            console.log('üìä –í–∞–ª–∏–¥–∞—Ü–∏—è:', validation);
            if (validation.valid) {
                orderData.promoValidation = validation;
                const result = await markPromoCodeAsUsed(promoCode, { name: 'Test User', contact: 'test@example.com' });
                console.log('üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:', result);
                return result;
            }
            return validation;
        };
    </script>
</body>
</html>
