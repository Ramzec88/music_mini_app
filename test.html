<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç Google Sheets</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            display: block;
            width: 100%;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin: 5px 0;
            display: inline-block;
        }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Google Sheets API</h1>
        
        <div id="status">
            <div class="status status-pending">‚è≥ –ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</div>
        </div>

        <button class="test-button" onclick="runBasicTest()">
            üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–∞–∑–æ–≤—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
        </button>

        <button class="test-button" onclick="testAPIEndpoint()">
            üì° –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API —Ñ—É–Ω–∫—Ü–∏—é
        </button>

        <button class="test-button" onclick="testReadData()">
            üìñ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        </button>

        <button class="test-button" onclick="testWriteData()">
            ‚úèÔ∏è –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö
        </button>

        <button class="test-button" onclick="clearLog()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
        </button>

        <div class="log" id="log">–õ–æ–≥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:\n</div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            logDiv.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            const statusClass = `status-${type}`;
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚è≥';
            statusDiv.innerHTML = `<div class="status ${statusClass}">${icon} ${message}</div>`;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '–õ–æ–≥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:\n';
            updateStatus('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'success');
        }

        async function runBasicTest() {
            log('üöÄ –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...', 'info');
            updateStatus('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞...', 'pending');

            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π URL
            log(`üåê –¢–µ–∫—É—â–∏–π URL: ${window.location.href}`, 'info');
            log(`üè† –î–æ–º–µ–Ω: ${window.location.hostname}`, 'info');

            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
            await testAPIEndpoint();

            // –¢–µ—Å—Ç 3: –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç —á—Ç–µ–Ω–∏—è
            await testReadData();

            log('üèÅ –ë–∞–∑–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'info');
        }

        async function testAPIEndpoint() {
            log('üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —Ñ—É–Ω–∫—Ü–∏–∏...', 'info');
            
            try {
                // –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ API
                const response = await fetch('/api/sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'test'
                    })
                });

                log(`üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status}`, 'info');
                log(`üìã –ó–∞–≥–æ–ª–æ–≤–∫–∏: ${JSON.stringify(Object.fromEntries(response.headers))}`, 'info');

                if (response.status === 404) {
                    log('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: API —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!', 'error');
                    log('üí° –†–ï–®–ï–ù–ò–ï: –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª api/sheets.js –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞', 'warning');
                    log('üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å: your-project/api/sheets.js', 'warning');
                    updateStatus('API —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    return false;
                }

                const responseText = await response.text();
                log(`üìÑ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤): ${responseText.substring(0, 200)}`, 'info');

                if (response.ok) {
                    log('‚úÖ API —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞', 'success');
                    updateStatus('API —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                    return true;
                } else {
                    log(`‚ö†Ô∏è API –æ—Ç–≤–µ—á–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π: ${response.status}`, 'warning');
                    
                    try {
                        const errorData = JSON.parse(responseText);
                        if (errorData.error && errorData.error.includes('configuration')) {
                            log('‚ùå –û–®–ò–ë–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò: –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã!', 'error');
                            log('üí° –†–ï–®–ï–ù–ò–ï: –î–æ–±–∞–≤—å—Ç–µ –≤ Vercel Environment Variables:', 'warning');
                            log('   - GOOGLE_SHEETS_API_KEY (–≤–∞—à API –∫–ª—é—á)', 'warning');
                            log('   - GOOGLE_SPREADSHEET_ID (ID —Ç–∞–±–ª–∏—Ü—ã)', 'warning');
                            updateStatus('–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã', 'error');
                        }
                    } catch (e) {
                        log('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API', 'error');
                    }
                    
                    return false;
                }

            } catch (error) {
                log(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                
                if (error.message.includes('Failed to fetch')) {
                    log('üåê –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∏–ª–∏ CORS', 'error');
                    log('üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:', 'warning');
                    log('   - –ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'warning');
                    log('   - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–æ', 'warning');
                    log('   - –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –±—Ä–∞—É–∑–µ—Ä–æ–º', 'warning');
                }
                
                updateStatus('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                return false;
            }
        }

        async function testReadData() {
            log('üìñ –¢–µ—Å—Ç–∏—Ä—É–µ–º —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets...', 'info');
            
            try {
                const response = await fetch('/api/sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'get',
                        sheetName: 'PromoCodes',
                        range: 'A1:A1'
                    })
                });

                log(`üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ —á—Ç–µ–Ω–∏—è: ${response.status}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${response.status} - ${errorText}`, 'error');
                    
                    if (response.status === 403) {
                        log('üîí –û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê: –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ Google Sheets', 'error');
                        log('üí° –†–ï–®–ï–ù–ò–Ø:', 'warning');
                        log('   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –≤ Google Cloud Console', 'warning');
                        log('   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω Google Sheets API', 'warning');
                        log('   - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–µ', 'warning');
                    } else if (response.status === 404) {
                        log('üìã –¢–ê–ë–õ–ò–¶–ê –ù–ï –ù–ê–ô–î–ï–ù–ê: –ù–µ–≤–µ—Ä–Ω—ã–π SPREADSHEET_ID', 'error');
                        log('üí° –†–ï–®–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ID —Ç–∞–±–ª–∏—Ü—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è', 'warning');
                    }
                    
                    updateStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö', 'error');
                    return;
                }

                const data = await response.json();
                log(`üìä –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã: ${JSON.stringify(data)}`, 'success');
                
                if (data.values) {
                    log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ ${data.values.length} —Å—Ç—Ä–æ–∫`, 'success');
                    updateStatus('–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
                } else {
                    log('‚ö†Ô∏è –¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –ª–∏—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
                    updateStatus('–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞', 'warning');
                }

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è', 'error');
            }
        }

        async function testWriteData() {
            log('‚úèÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets...', 'info');
            
            try {
                const testData = [
                    `test_${Date.now()}@example.com`,
                    '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    new Date().toISOString(),
                    new Date().toISOString(),
                    'diagnostic_test'
                ];

                log(`üìù –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(testData)}`, 'info');

                const response = await fetch('/api/sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'append',
                        sheetName: 'Users',
                        values: testData
                    })
                });

                log(`üìä –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –∑–∞–ø–∏—Å–∏: ${response.status}`, 'info');

                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ${response.status} - ${errorText}`, 'error');
                    
                    if (response.status === 403) {
                        log('üîí –û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê: –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ Google Sheets', 'error');
                        log('üí° –†–ï–®–ï–ù–ò–Ø:', 'warning');
                        log('   - –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã', 'warning');
                        log('   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ API –∫–ª—é—á –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å', 'warning');
                    }
                    
                    updateStatus('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                    return;
                }

                const result = await response.json();
                log(`‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ: ${JSON.stringify(result)}`, 'success');
                updateStatus('–ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');

            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
                updateStatus('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏', 'error');
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            log('üîß –°–∏—Å—Ç–µ–º–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–ø—É—â–µ–Ω–∞', 'info');
            log('üí° –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–∞–∑–æ–≤—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É" –¥–ª—è –Ω–∞—á–∞–ª–∞', 'info');
            log('üìã –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏', 'info');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–µ–¥–µ
            setTimeout(() => {
                log(`üåç User Agent: ${navigator.userAgent}`, 'info');
                log(`üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${navigator.platform}`, 'info');
                log(`üåê –Ø–∑—ã–∫: ${navigator.language}`, 'info');
            }, 1000);
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ JavaScript
        window.addEventListener('error', function(e) {
            log(`üí• JavaScript –æ—à–∏–±–∫–∞: ${e.message}`, 'error');
            log(`üìÅ –§–∞–π–ª: ${e.filename}:${e.lineno}`, 'error');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω—ã—Ö Promise –æ—à–∏–±–æ–∫
        window.addEventListener('unhandledrejection', function(e) {
            log(`üí• –ù–µ–ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ Promise: ${e.reason}`, 'error');
        });

    </script>
</body>
</html>
