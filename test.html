<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç Google Sheets API</title>
</head>
<body>
    <h1>–¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Google Sheets API</h1>
    <div id="results"></div>
    <button onclick="testAPI()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API</button>
    <button onclick="testSheets()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Sheets</button>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.style.padding = '10px';
            div.style.margin = '5px 0';
            div.style.borderRadius = '5px';
            div.style.backgroundColor = type === 'error' ? '#ffe6e6' : type === 'success' ? '#e6ffe6' : '#e6f3ff';
            div.textContent = message;
            results.appendChild(div);
        }
        
        async function testAPI() {
            results.innerHTML = '';
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º API endpoint...');
            
            try {
                const res = await fetch('/api/env');
                log(`üì° Response status: ${res.status}`);
                
                if (!res.ok) {
                    log(`‚ùå API Error: ${res.status} ${res.statusText}`, 'error');
                    return;
                }
                
                const data = await res.json();
                log('‚úÖ API Response –ø–æ–ª—É—á–µ–Ω', 'success');
                log(`üîë API Key –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${!!data.GOOGLE_SHEETS_API_KEY ? '–î–ê' : '–ù–ï–¢'}`);
                log(`üìä Spreadsheet ID –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç: ${!!data.GOOGLE_SPREADSHEET_ID ? '–î–ê' : '–ù–ï–¢'}`);
                
                if (data.GOOGLE_SHEETS_API_KEY) {
                    log(`üîë API Key: ${data.GOOGLE_SHEETS_API_KEY.substring(0, 20)}...`);
                }
                if (data.GOOGLE_SPREADSHEET_ID) {
                    log(`üìä Spreadsheet ID: ${data.GOOGLE_SPREADSHEET_ID}`);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞
                window.GOOGLE_CONFIG = data;
                
            } catch (error) {
                log(`‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        async function testSheets() {
            if (!window.GOOGLE_CONFIG) {
                log('‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç API', 'error');
                return;
            }
            
            const { GOOGLE_SHEETS_API_KEY, GOOGLE_SPREADSHEET_ID } = window.GOOGLE_CONFIG;
            
            if (!GOOGLE_SHEETS_API_KEY || !GOOGLE_SPREADSHEET_ID) {
                log('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã', 'error');
                return;
            }
            
            log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –∫ Google Sheets...');
            
            try {
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
                const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SPREADSHEET_ID}?key=${GOOGLE_SHEETS_API_KEY}`;
                
                log('üì° –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Google Sheets API...');
                const response = await fetch(metadataUrl);
                
                log(`üì° Google API Response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`‚ùå Google API Error: ${response.status} - ${errorText}`, 'error');
                    
                    if (response.status === 403) {
                        log('üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ 403:', 'info');
                        log('- API Key –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
                        log('- Google Sheets API –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç–µ');
                        log('- –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤');
                    } else if (response.status === 404) {
                        log('üí° –û—à–∏–±–∫–∞ 404: –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'info');
                    }
                    return;
                }
                
                const data = await response.json();
                log('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ Google Sheets!', 'success');
                log(`üìä –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã: ${data.properties.title}`);
                log(`üìÑ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç–æ–≤: ${data.sheets.length}`);
                
                data.sheets.forEach((sheet, index) => {
                    log(`üìù –õ–∏—Å—Ç ${index + 1}: ${sheet.properties.title}`);
                });
                
                // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –Ω—É–∂–Ω—ã–µ –ª–∏—Å—Ç—ã
                const requiredSheets = ['PromoCodes', 'Orders', 'Users'];
                const existingSheets = data.sheets.map(s => s.properties.title);
                
                requiredSheets.forEach(sheetName => {
                    if (existingSheets.includes(sheetName)) {
                        log(`‚úÖ –õ–∏—Å—Ç "${sheetName}" –Ω–∞–π–¥–µ–Ω`, 'success');
                    } else {
                        log(`‚ùå –õ–∏—Å—Ç "${sheetName}" –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç`, 'error');
                    }
                });
                
            } catch (error) {
                log(`‚ùå Network Error: ${error.message}`, 'error');
            }
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', testAPI);
    </script>
</body>
</html>
